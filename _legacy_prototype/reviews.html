<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Note | ì„¸ì…ìë¥¼ ìœ„í•œ ì•ˆì „ ì§€í‚´ì´</title>
    <meta name="description" content="ë“±ê¸°ë¶€ë“±ë³¸ ë¶„ì„ë¶€í„° ì‹¤ê±°ì£¼ ì°í›„ê¸°ê¹Œì§€. 2030 ì „ì›”ì„¸ ê³„ì•½ì˜ ëª¨ë“  ê²ƒ.">
    <meta property="og:title" content="Tenant Note - ë‚´ ë³´ì¦ê¸ˆ ì§€í‚¤ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•">
    <meta property="og:description" content="í˜„ì§ ê°ì •í‰ê°€ì‚¬ê°€ ë§Œë“  ì „ì›”ì„¸ ì•ˆì „ ì§„ë‹¨ & ê°€ì´ë“œ">
    <meta property="og:image" content="https://via.placeholder.com/1200x630/2563eb/ffffff?text=Tenant+Note">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Moved here per refactoring request -->
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=693e61b56c8dfdcac6b196b6fa46e513&libraries=services,clusterer"></script>
    <script src="js/config.js"></script>
    <style>
        body {
            font-family: "Pretendard Variable", Pretendard, sans-serif;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Listing Marker Styles */
        .listing-marker {
            background: #2563eb;
            color: white;
            border-radius: 4px;
            padding: 4px 8px;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
        }

        .listing-marker:hover {
            transform: scale(1.1) translateY(-2px);
            background: #1d4ed8;
            z-index: 60 !important;
        }

        .listing-marker::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #2563eb;
        }

        .listing-marker:hover::after {
            border-top-color: #1d4ed8;
        }

        .listing-marker:hover::after {
            border-top-color: #1d4ed8;
        }

        /* Grade Colors for Markers */
        .marker-grade-A {
            background: #22c55e !important;
        }

        /* Green */
        .marker-grade-A::after {
            border-top-color: #22c55e !important;
        }

        .marker-grade-B {
            background: #eab308 !important;
        }

        /* Yellow */
        .marker-grade-B::after {
            border-top-color: #eab308 !important;
        }

        .marker-grade-C {
            background: #f97316 !important;
        }

        /* Orange */
        .marker-grade-C::after {
            border-top-color: #f97316 !important;
        }

        .marker-grade-D {
            background: #ef4444 !important;
        }

        /* Red */
        .marker-grade-D::after {
            border-top-color: #ef4444 !important;
        }

        /* Custom Map Overlay Tooltip Style (from Request) */
        .customoverlay {
            position: relative;
            bottom: 50px;
            border-radius: 6px;
            border: 1px solid #ccc;
            border-bottom: 2px solid #ddd;
            float: left;
        }

        .customoverlay:nth-of-type(n) {
            border: 0;
            box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.2);
        }

        .customoverlay a {
            display: block;
            text-decoration: none;
            color: #222;
            text-align: center;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            overflow: hidden;
            background: #fff;
            background: #fff url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/arrow_white.png') no-repeat right 10px center;
        }

        .customoverlay .title {
            display: block;
            text-align: center;
            background: #fff;
            margin-right: 30px;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }

        .customoverlay:after {
            content: '';
            position: absolute;
            margin-left: -10px;
            left: 50%;
            bottom: -10px;
            width: 20px;
            height: 10px;
            background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png');
        }

        /* Sidebar Transition */
        aside {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Filter Buttons */
        .filter-type-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .filter-size-btn.active {
            background-color: #eff6ff;
            color: #2563eb;
            border-color: #2563eb;
            font-weight: 700;
        }

        .deal-toggle-btn.active {
            background: white;
            color: #2563eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* Toast Message */
        #toast-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast-msg {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: toastFadeIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            backdrop-filter: blur(4px);
        }

        @keyframes toastFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast-out {
            animation: toastFadeOut 0.3s forwards;
        }

        @keyframes toastFadeOut {
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* CCTV Marker */
        .cctv-marker {
            width: 24px;
            height: 24px;
            background-color: #2563eb;
            /* Blue-600 */
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        @keyframes popIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        /* Personalization Toast */
        #persona-toast {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-900 h-screen flex flex-col">

    <!-- Persona Toast (Initially Hidden) -->
    <div id="persona-toast"
        class="fixed top-24 left-1/2 transform -translate-x-1/2 z-[100] px-6 py-4 rounded-full shadow-2xl flex items-center gap-4 hidden animate-fade-in-up">
        <div class="bg-white/20 rounded-full w-10 h-10 flex items-center justify-center text-xl shrink-0">
            <span id="persona-emoji">ğŸ›¡ï¸</span>
        </div>
        <div>
            <p class="text-sm font-bold text-indigo-100 mb-0.5">ë‚´ ì£¼ê±° ì„±í–¥ ë¶„ì„ ì™„ë£Œ!</p>
            <p class="font-bold text-white text-base"><span id="persona-name" class="text-yellow-300">ì²­ì™€ëŒ€ ê²½í˜¸ì‹¤ì¥í˜•</span>
                ë§ì¶¤ ì§€ë„ë¥¼ ë³´ì—¬ë“œë ¤ìš”.</p>
        </div>
        <button onclick="document.getElementById('persona-toast').classList.add('hidden')"
            class="text-white/70 hover:text-white ml-2">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-50 w-full border-b border-gray-200 bg-white/95 backdrop-blur-md">
        <div class="mx-auto flex h-24 max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8">
            <a href="index.html" class="flex flex-col leading-none group">
                <div class="flex items-center gap-1.5">
                    <span
                        class="text-2xl font-black text-blue-600 tracking-tight group-hover:scale-105 transition-transform">Tenant
                        Note</span>
                    <span class="rounded-full bg-blue-100 px-2 py-0.5 text-[11px] font-bold text-blue-700">Beta</span>
                </div>
                <span class="text-xs font-medium text-gray-400 mt-1.5 tracking-wide">ì„¸ì…ìë¥¼ ìœ„í•œ ì•ˆì „ ì§€í‚´ì´</span>
            </a>

            <nav class="hidden md:flex items-center gap-10">
                <a href="reviews.html" class="group flex flex-col items-center justify-center gap-1 py-2">
                    <span class="text-lg font-bold text-gray-800 transition group-hover:text-blue-600">ë™ë„¤ ë¶„ì„</span>
                    <span class="text-xs font-medium text-gray-500 transition group-hover:text-blue-500">ì—¬ê¸° ì‚´ê¸°
                        ì–´ë•Œìš”?</span>
                </a>
                <a href="safety.html" class="group flex flex-col items-center justify-center gap-1 py-2">
                    <span class="text-lg font-bold text-gray-800 transition group-hover:text-blue-600">ë¬¼ê±´ ë¶„ì„</span>
                    <span class="text-xs font-medium text-gray-500 transition group-hover:text-blue-500">ì—¬ê¸° ê³„ì•½í•´ë„
                        ë ê¹Œ?</span>
                </a>
                <a href="guide.html" class="group flex flex-col items-center justify-center gap-1 py-2">
                    <span class="text-lg font-bold text-gray-800 transition group-hover:text-blue-600">ê³„ì•½/ì´ì‚¬ ê°€ì´ë“œ</span>
                    <span class="text-xs font-medium text-gray-500 transition group-hover:text-blue-500">ì´ì œ ë­˜ í•´ì•¼
                        í•˜ì§€?</span>
                </a>
                <a href="community.html" class="group flex flex-col items-center justify-center gap-1 py-2">
                    <span class="text-lg font-bold text-gray-800 transition group-hover:text-blue-600">í…Œë„ŒíŠ¸ ë¼ìš´ì§€</span>
                    <span class="text-xs font-medium text-gray-500 transition group-hover:text-blue-500">ë‚˜ë‘ ê°™ì€ ê³ ë¯¼
                        ìƒë‹´</span>
                </a>
                <a href="insight.html" class="group flex flex-col items-center justify-center gap-1 py-2">
                    <span class="text-lg font-bold text-gray-800 transition group-hover:text-blue-600">ì¸ì‚¬ì´íŠ¸</span>
                    <span class="text-xs font-medium text-gray-500 transition group-hover:text-blue-500">ì „ë¬¸ê°€ì˜
                        íŒ©íŠ¸ì²´í¬</span>
                </a>
            </nav>

            <div class="hidden md:flex items-center gap-4">
                <button class="text-base font-semibold text-gray-500 hover:text-gray-900 transition">ë¡œê·¸ì¸</button>
                <a href="#" onclick="document.getElementById('review-modal').classList.remove('hidden'); return false;"
                    class="rounded-xl bg-blue-600 px-5 py-2.5 text-base font-bold text-white shadow-lg hover:bg-blue-500 transition hover:-translate-y-0.5">
                    í›„ê¸° ë‚¨ê¸°ê¸°
                </a>
            </div>

            <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-600 hover:text-blue-600 focus:outline-none">
                <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
            </button>
        </div>

        <div id="mobile-menu" class="hidden md:hidden border-t border-gray-100 bg-white">
            <div class="space-y-1 px-4 py-6">
                <a href="reviews.html"
                    class="block rounded-lg px-4 py-3 text-base font-bold text-gray-800 hover:bg-blue-50 hover:text-blue-600">ë™ë„¤
                    ë¶„ì„ <span class="ml-2 text-xs font-normal text-gray-500">ì—¬ê¸° ì‚´ê¸° ì–´ë•Œìš”?</span></a>
                <a href="safety.html"
                    class="block rounded-lg px-4 py-3 text-base font-bold text-gray-800 hover:bg-blue-50 hover:text-blue-600">ë¬¼ê±´
                    ë¶„ì„ <span class="ml-2 text-xs font-normal text-gray-500">ì—¬ê¸° ê³„ì•½í•´ë„ ë ê¹Œ?</span></a>
                <a href="guide.html"
                    class="block rounded-lg px-4 py-3 text-base font-bold text-gray-800 hover:bg-blue-50 hover:text-blue-600">ê³„ì•½/ì´ì‚¬
                    ê°€ì´ë“œ <span class="ml-2 text-xs font-normal text-gray-500">ì´ì œ ë­˜ í•´ì•¼ í•˜ì§€?</span></a>
                <a href="community.html"
                    class="block rounded-lg px-4 py-3 text-base font-bold text-gray-800 hover:bg-blue-50 hover:text-blue-600">í…Œë„ŒíŠ¸
                    ë¼ìš´ì§€
                    <span class="ml-2 text-xs font-normal text-gray-500">ë‚˜ë‘ ê°™ì€ ê³ ë¯¼ ìƒë‹´</span></a>
                <a href="insight.html"
                    class="block rounded-lg px-4 py-3 text-base font-bold text-gray-800 hover:bg-blue-50 hover:text-blue-600">ì¸ì‚¬ì´íŠ¸
                    <span class="ml-2 text-xs font-normal text-gray-500">ì „ë¬¸ê°€ì˜ íŒ©íŠ¸ì²´í¬</span></a>
                <div class="mt-6 border-t border-gray-100 pt-6">
                    <a href="#"
                        class="block w-full rounded-lg bg-gray-100 px-4 py-3 text-center text-base font-bold text-gray-600 hover:bg-gray-200">ë¡œê·¸ì¸</a>
                    <a href="#"
                        onclick="document.getElementById('review-modal').classList.remove('hidden'); return false;"
                        class="mt-3 block w-full rounded-lg bg-blue-600 px-4 py-3 text-center text-base font-bold text-white hover:bg-blue-500">í›„ê¸°
                        ë‚¨ê¸°ê¸°</a>
                </div>
            </div>
        </div>

    </header>

    <main class="flex-1 flex overflow-hidden relative">

        <!-- Sidebar: Using existing content but wrapping in the requested structure -->
        <aside id="sidebar"
            class="w-full md:w-[400px] bg-white border-r border-gray-200 flex flex-col z-20 absolute md:relative h-full translate-y-full md:translate-y-0 shrink-0 shadow-2xl md:shadow-none transition-transform duration-300">
            <!-- 1. Search & Filter Section -->
            <div class="p-4 border-b border-slate-100 bg-white shrink-0 space-y-4">
                <!-- Search -->
                <div>
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                        <input type="text" value="ì‹ ë¦¼ì—­" readonly
                            class="w-full pl-9 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:outline-none cursor-default">
                    </div>
                </div>

                <!-- Deal Type Toggle -->
                <div class="bg-slate-100 p-1 rounded-lg flex">
                    <button onclick="setDealType('jeonse')" id="deal-jeonse"
                        class="deal-toggle-btn flex-1 py-1.5 text-xs font-bold text-slate-500 rounded-md transition-all">ì „ì„¸</button>
                    <button onclick="setDealType('monthly')" id="deal-monthly"
                        class="deal-toggle-btn active flex-1 py-1.5 text-xs font-bold text-slate-500 rounded-md transition-all">ì›”ì„¸</button>
                </div>

                <!-- Housing Type -->
                <div>
                    <span class="text-xs font-bold text-slate-400 mb-1.5 block">ì£¼ê±° ìœ í˜• (ì¤‘ë³µ ì„ íƒ)</span>
                    <div class="flex gap-2">
                        <button onclick="toggleType('APT')"
                            class="filter-type-btn active flex-1 py-2 rounded-lg border border-slate-200 bg-gray-50 text-xs font-medium text-slate-500 transition-colors"
                            data-type="APT">ì•„íŒŒíŠ¸</button>
                        <button onclick="toggleType('OP')"
                            class="filter-type-btn active flex-1 py-2 rounded-lg border border-slate-200 bg-gray-50 text-xs font-medium text-slate-500 transition-colors"
                            data-type="OP">ì˜¤í”¼ìŠ¤í…”</button>
                        <button onclick="toggleType('YH')"
                            class="filter-type-btn active flex-1 py-2 rounded-lg border border-slate-200 bg-gray-50 text-xs font-medium text-slate-500 transition-colors"
                            data-type="YH">ì—°ë¦½/ë‹¤ì„¸ëŒ€</button>
                        <button onclick="toggleType('DD')"
                            class="filter-type-btn active flex-1 py-2 rounded-lg border border-slate-200 bg-gray-50 text-xs font-medium text-slate-500 transition-colors"
                            data-type="DD">ë‹¨ë…/ë‹¤ê°€êµ¬</button>
                    </div>
                </div>

                <!-- Size -->
                <div>
                    <span class="text-xs font-bold text-slate-400 mb-1.5 block">í‰í˜•ëŒ€</span>
                    <div class="flex gap-1.5 overflow-x-auto hide-scrollbar">
                        <button onclick="setSize('all')"
                            class="filter-size-btn active px-3 py-1.5 rounded-full border border-slate-200 text-xs font-medium text-slate-500 whitespace-nowrap"
                            data-size="all">ì „ì²´</button>
                        <button onclick="setSize('under10')"
                            class="filter-size-btn px-3 py-1.5 rounded-full border border-slate-200 text-xs font-medium text-slate-500 whitespace-nowrap"
                            data-size="under10">~10í‰</button>
                        <button onclick="setSize('10to20')"
                            class="filter-size-btn px-3 py-1.5 rounded-full border border-slate-200 text-xs font-medium text-slate-500 whitespace-nowrap"
                            data-size="10to20">10~20í‰</button>
                        <button onclick="setSize('over30')"
                            class="filter-size-btn px-3 py-1.5 rounded-full border border-slate-200 text-xs font-medium text-slate-500 whitespace-nowrap"
                            data-size="over30">30í‰~</button>
                    </div>
                </div>

                <!-- Budget Filter -->
                <div class="mt-6 mb-2">
                    <h3 class="text-xs font-bold text-slate-500 mb-2">ì˜ˆì‚° ì„¤ì • (ë‹¨ìœ„: ë§Œì›)</h3>
                    <div class="space-y-2">
                        <div>
                            <label class="text-[10px] text-slate-400 mb-1 block">ë³´ì¦ê¸ˆ/ì „ì„¸ê¸ˆ</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="budget-dep-min" placeholder="ìµœì†Œ" oninput="applyFilter()"
                                    class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-xs outline-none focus:border-blue-500">
                                <span class="text-slate-400">~</span>
                                <input type="number" id="budget-dep-max" placeholder="ìµœëŒ€" oninput="applyFilter()"
                                    class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-xs outline-none focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-400 mb-1 block">ì›”ì„¸</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="budget-rent-min" placeholder="ìµœì†Œ" oninput="applyFilter()"
                                    class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-xs outline-none focus:border-blue-500">
                                <span class="text-slate-400">~</span>
                                <input type="number" id="budget-rent-max" placeholder="ìµœëŒ€" oninput="applyFilter()"
                                    class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-xs outline-none focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Listing Results -->
            <div id="sidebar-content" class="flex-1 overflow-y-auto bg-slate-50 p-4 relative"
                onscroll="handleScroll(this)">
                <!-- Content will be injected here -->
            </div>

            <!-- Mobile Close -->
            <div class="md:hidden p-3 bg-white border-t border-slate-100 text-center cursor-pointer"
                onclick="toggleSidebar(false)">
                <span class="text-sm font-bold text-slate-400">ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</span>
            </div>
        </aside>

        <!-- Right Content Area -->
        <div class="flex-1 flex flex-col relative w-full h-full overflow-hidden">
            <section class="flex-1 relative w-full h-full" id="map-container">
                <div id="map" class="w-full h-full"></div>

                <!-- Layer Options Wrapper -->
                <div class="absolute top-4 right-4 z-20" id="layer-options-wrapper">
                    <!-- Trigger Button -->
                    <button onclick="toggleLayerPanel()" title="ì§€ë„ ì˜µì…˜"
                        class="w-10 h-10 bg-white rounded-lg shadow-md border border-slate-200 flex items-center justify-center hover:bg-slate-50 transition-colors cursor-pointer focus:outline-none">
                        <i class="fa-solid fa-layer-group text-slate-700 text-lg"></i>
                    </button>
                    <!-- Unit Toggle Button -->
                    <button onclick="toggleUnit()" title="ë‹¨ìœ„ ë³€í™˜"
                        class="mt-2 w-10 h-10 bg-white rounded-lg shadow-md border border-slate-200 flex flex-col items-center justify-center hover:bg-slate-50 transition-colors cursor-pointer focus:outline-none text-[10px] font-bold text-slate-600">
                        <span id="unit-pyeong" class="text-blue-600">í‰</span>
                        <span class="w-full h-[1px] bg-slate-100 my-0.5"></span>
                        <span id="unit-m2" class="text-slate-400">ã¡</span>
                    </button>

                    <!-- Popover Panel -->
                    <div id="layer-options-panel"
                        class="hidden absolute top-12 right-0 bg-white rounded-xl shadow-xl p-4 w-64 border border-slate-100 transition-all duration-200 ease-in-out">
                        <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-sm">
                            <i class="fa-solid fa-layer-group text-blue-600"></i> ë ˆì´ì–´ ì˜µì…˜
                        </h4>

                        <!-- View Mode Selector -->
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-slate-500 mb-1">ğŸ‘€ ì§€ë„ ì±„ìƒ‰ ê¸°ì¤€</label>
                            <select id="view-mode-select" onchange="changeViewMode(this.value)"
                                class="w-full text-xs border border-slate-200 rounded px-2 py-1.5 text-slate-700 focus:outline-none focus:border-blue-500">
                                <option value="total">ğŸ… ì¢…í•© ì•ˆì‹¬ ë“±ê¸‰</option>
                                <option value="security">ğŸ‘® ì¹˜ì•ˆ/ì•ˆì „ ë“±ê¸‰</option>
                                <option value="building">ğŸ¢ ë¬¼ê±´/ê±´ë¬¼ ë“±ê¸‰</option>
                                <option value="comfort">ğŸŒ¿ ì£¼ê±° ì¾Œì ì„± ë“±ê¸‰</option>
                                <option value="infra">ğŸª ìƒí™œ ì¸í”„ë¼ ë“±ê¸‰</option>
                                <option value="traffic">ğŸš‡ êµí†µ ì ‘ê·¼ì„± ë“±ê¸‰</option>
                                <option value="env">ğŸ”Š í™˜ê²½/ì†ŒìŒ ë“±ê¸‰</option>
                            </select>
                        </div>

                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-green-500/50 border border-green-500"></span>
                                <span class="text-sm font-medium text-gray-700">ì•ˆì‹¬ êµ¬ì—­ (ë¶„ì„)</span>
                            </div>
                            <button id="btn-toggle-polygon" onclick="toggleLayer('polygon')"
                                class="w-11 h-6 bg-blue-600 rounded-full relative transition-colors focus:outline-none">
                                <span
                                    class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform translate-x-5"></span>
                            </button>
                        </div>

                        <!-- Special Zones Toggle Section -->
                        <div class="mb-3 pt-3 border-t border-slate-50">
                            <h4 class="text-xs font-bold text-slate-500 mb-2">íŠ¹ìˆ˜ ì •ë³´</h4>
                            <div class="space-y-2">
                                <label class="flex items-center justify-between cursor-pointer group">
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-volume-high text-red-500 text-xs"></i>
                                        <span class="text-sm text-slate-600 group-hover:text-slate-800">ì†ŒìŒ/ìœ í•´ êµ¬ì—­</span>
                                    </div>
                                    <input type="checkbox" onchange="toggleSpecialLayer('noise', this.checked)"
                                        class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                                </label>
                                <label class="flex items-center justify-between cursor-pointer group">
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-graduation-cap text-purple-500 text-xs"></i>
                                        <span class="text-sm text-slate-600 group-hover:text-slate-800">í•™ì›ê°€/ìƒê¶Œ</span>
                                    </div>
                                    <input type="checkbox" onchange="toggleSpecialLayer('academy', this.checked)"
                                        class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                                </label>
                                <label class="flex items-center justify-between cursor-pointer group">
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-mountain text-amber-800 text-xs"></i>
                                        <span class="text-sm text-slate-600 group-hover:text-slate-800">ì§€í˜•/ê²½ì‚¬ë„</span>
                                    </div>
                                    <input type="checkbox" onchange="toggleSpecialLayer('hill', this.checked)"
                                        class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                                </label>
                            </div>
                        </div>

                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-sm bg-blue-600 flex items-center justify-center">
                                    <i class="fa-solid fa-won-sign text-[8px] text-white"></i>
                                </span>
                                <span class="text-sm font-medium text-gray-700">ì‹œì„¸ ë³´ê¸° (ì‹¤ê±°ë˜)</span>
                            </div>
                            <button id="btn-toggle-marker" onclick="toggleLayer('marker')"
                                class="w-11 h-6 bg-blue-600 rounded-full relative transition-colors focus:outline-none">
                                <span
                                    class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform translate-x-5"></span>
                            </button>
                        </div>

                        <div class="mb-4">
                            <h4 class="text-xs font-bold text-slate-500 mb-2">ì•ˆì‹¬ ë“±ê¸‰ (ë¶„ì„)</h4>
                            <div class="flex gap-2">
                                <button id="btn-grade-A" onclick="toggleGradeLayer('A')"
                                    class="flex-1 py-1 text-[10px] font-bold text-white bg-green-500 rounded shadow-sm hover:opacity-80 transition-opacity">
                                    Grade A
                                </button>
                                <button id="btn-grade-B" onclick="toggleGradeLayer('B')"
                                    class="flex-1 py-1 text-[10px] font-bold text-white bg-yellow-500 rounded shadow-sm hover:opacity-80 transition-opacity">
                                    Grade B
                                </button>
                                <button id="btn-grade-C" onclick="toggleGradeLayer('C')"
                                    class="flex-1 py-1 text-[10px] font-bold text-white bg-orange-500 rounded shadow-sm hover:opacity-80 transition-opacity">
                                    Grade C
                                </button>
                                <button id="btn-grade-D" onclick="toggleGradeLayer('D')"
                                    class="flex-1 py-1 text-[10px] font-bold text-white bg-red-500 rounded shadow-sm hover:opacity-80 transition-opacity">
                                    Grade D
                                </button>
                            </div>
                        </div>

                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-purple-600 flex items-center justify-center">
                                    <i class="fa-solid fa-star text-[6px] text-white"></i>
                                </span>
                                <span
                                    class="text-sm font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">ì°
                                    í›„ê¸° (ì…ì£¼ë¯¼)</span>
                            </div>
                            <button id="btn-toggle-review" onclick="toggleLayer('review')"
                                class="w-11 h-6 bg-gray-200 rounded-full relative transition-colors focus:outline-none">
                                <span
                                    class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform"></span>
                            </button>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-blue-500 flex items-center justify-center">
                                    <i class="fa-solid fa-video text-[6px] text-white"></i>
                                </span>
                                <span class="text-sm font-medium text-gray-700">ì•ˆì‹¬ CCTV (ë°©ë²”ìš©)</span>
                            </div>
                            <button id="btn-toggle-cctv" onclick="toggleLayer('cctv')"
                                class="w-11 h-6 bg-gray-200 rounded-full relative transition-colors focus:outline-none">
                                <span
                                    class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="map-loader"
                    class="hidden absolute inset-0 bg-white/50 z-50 flex items-center justify-center backdrop-blur-sm">
                    <div class="bg-white p-4 rounded-xl shadow-xl flex flex-col items-center">
                        <i class="fa-solid fa-circle-notch fa-spin text-2xl text-blue-600 mb-2"></i>
                        <span class="text-xs font-bold text-slate-600">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</span>
                    </div>
                </div>
            </section>

            <!-- Bottom Data Grid (Excel Style) -->
            <section id="data-grid-panel"
                class="hidden md:flex flex-col bg-white border-t border-gray-200 transition-all duration-300 z-30 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] h-10">
                <!-- Header Bar -->
                <div class="flex items-center justify-between px-4 py-2 bg-gray-50 border-b border-gray-200">
                    <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                        <i class="fa-solid fa-list-ul text-blue-600"></i>
                        ì‹¤ê±°ë˜ ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ (<span id="grid-count" class="text-blue-600">0</span>ê±´)
                    </h3>
                    <button onclick="toggleGrid()"
                        class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-500 transition-colors">
                        <i id="grid-toggle-icon" class="fa-solid fa-chevron-up text-sm"></i>
                    </button>
                </div>

                <!-- Table Container -->
                <div class="flex-1 overflow-auto relative">
                    <table class="w-full text-left border-collapse">
                        <thead
                            class="sticky top-0 z-10 bg-gray-50 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200 shadow-sm">
                            <tr>
                                <th class="px-4 py-3 w-16 text-center border-r border-gray-100">ìƒíƒœ</th>
                                <th class="px-4 py-3 border-r border-gray-100">ê±´ë¬¼ëª…</th>
                                <th class="px-4 py-3 w-20 text-center border-r border-gray-100">ê±°ë˜</th>
                                <th class="px-4 py-3 text-right border-r border-gray-100">ê°€ê²©</th>
                                <th class="px-4 py-3 text-right border-r border-gray-100">ë©´ì /ì¸µ</th>
                                <th class="px-4 py-3 text-right w-32">ì‹¤ê±°ë˜ì¼</th>
                            </tr>
                        </thead>
                        <tbody id="data-grid-body" class="text-sm text-gray-700 divide-y divide-gray-100 bg-white">
                            <!-- Rows Injected Here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>



    </main>

    <!-- Global Footer -->
    <footer class="bg-gray-900 border-t border-gray-800 text-gray-500 py-1.5 shrink-0 z-40 relative">
        <div class="w-full px-4 flex justify-between items-center text-[10px] leading-none">
            <span>&copy; 2026 Tenant Note.</span>
            <div class="flex gap-3">
                <a href="#" class="hover:text-gray-300 transition">ì´ìš©ì•½ê´€</a>
                <span class="text-gray-700">|</span>
                <a href="#" class="hover:text-gray-300 transition">ë¬¸ì˜í•˜ê¸°</a>
            </div>
        </div>
    </footer>
    <!-- Global Review Write Modal -->
    <div id="review-modal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[150] hidden flex items-end md:items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-t-3xl md:rounded-3xl p-6 shadow-2xl animate-fade-in-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-900">ì‚´ì•„ë³¸ ì§‘ì˜ ì°í›„ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”!</h3>
                <button onclick="document.getElementById('review-modal').classList.add('hidden')"
                    class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <!-- 1. Address Search -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">ì–´ë””ì— ì‚¬ì…¨ë‚˜ìš”?</label>
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="text" placeholder="ë„ë¡œëª… ì£¼ì†Œë‚˜ ê±´ë¬¼ëª… ê²€ìƒ‰"
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 text-sm font-bold outline-none focus:border-blue-500 transition-colors">
                    </div>
                </div>

                <!-- 2. Period -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">ê±°ì£¼ ê¸°ê°„</label>
                    <div class="grid grid-cols-2 gap-2">
                        <select
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:border-blue-500">
                            <option>2024ë…„</option>
                            <option>2023ë…„</option>
                            <option>2022ë…„</option>
                            <option>2021ë…„ ì´ì „</option>
                        </select>
                        <select
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:border-blue-500">
                            <option>1ë…„ ë¯¸ë§Œ</option>
                            <option>1ë…„</option>
                            <option>2ë…„ ì´ìƒ</option>
                        </select>
                    </div>
                </div>

                <!-- 3. Rating -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">ì´ ì§‘ì˜ ì´ì ì€?</label>
                    <div class="flex gap-2 justify-center py-4 bg-slate-50 rounded-xl border border-slate-200">
                        <i class="fa-solid fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400"
                            onclick="this.classList.toggle('text-yellow-400'); this.classList.toggle('text-gray-300')"></i>
                        <i class="fa-solid fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400"
                            onclick="this.classList.toggle('text-yellow-400'); this.classList.toggle('text-gray-300')"></i>
                        <i class="fa-solid fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400"
                            onclick="this.classList.toggle('text-yellow-400'); this.classList.toggle('text-gray-300')"></i>
                        <i class="fa-solid fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400"
                            onclick="this.classList.toggle('text-yellow-400'); this.classList.toggle('text-gray-300')"></i>
                        <i class="fa-solid fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400"
                            onclick="this.classList.toggle('text-yellow-400'); this.classList.toggle('text-gray-300')"></i>
                    </div>
                </div>

                <!-- 4. Pros/Cons -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-blue-600 mb-1">ì¥ì </label>
                        <textarea
                            class="w-full h-24 bg-blue-50/50 border border-blue-100 rounded-xl p-3 text-sm resize-none outline-none focus:border-blue-500"
                            placeholder="ì±„ê´‘, ì¹˜ì•ˆ, êµí†µ ë“± ë§Œì¡±ìŠ¤ëŸ¬ìš´ ì "></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-red-500 mb-1">ë‹¨ì </label>
                        <textarea
                            class="w-full h-24 bg-red-50/50 border border-red-100 rounded-xl p-3 text-sm resize-none outline-none focus:border-red-500"
                            placeholder="ì†ŒìŒ, ë²Œë ˆ, ê³°íŒ¡ì´ ë“± ì•„ì‰¬ìš´ ì "></textarea>
                    </div>
                </div>

                <button
                    onclick="alert('ì†Œì¤‘í•œ í›„ê¸° ê°ì‚¬í•©ë‹ˆë‹¤! 500Pê°€ ì ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤.'); document.getElementById('review-modal').classList.add('hidden')"
                    class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-800 transition-all transform hover:scale-[1.02]">
                    ë“±ë¡í•˜ê³  í¬ì¸íŠ¸ ë°›ê¸° ğŸ’°
                </button>
            </div>
        </div>
    </div>
    <!-- Map Legend Toggle -->
    <button onclick="toggleLegend()"
        class="fixed bottom-6 right-4 z-50 bg-white text-slate-700 p-3 rounded-full shadow-lg border border-slate-200 hover:bg-slate-50 transition-all focus:outline-none hover:scale-105 active:scale-95 group">
        <i class="fa-solid fa-circle-question text-xl text-blue-600 group-hover:text-blue-700"></i>
    </button>

    <!-- Map Legend Panel -->
    <div id="map-legend"
        class="hidden fixed bottom-20 right-4 z-50 bg-white/90 backdrop-blur-md p-5 rounded-2xl shadow-2xl border border-white/50 w-72 animate-fade-in-up">
        <div class="flex justify-between items-center mb-4 border-b border-slate-200/50 pb-3">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider">ì§€ë„ ê°€ì´ë“œ</h4>
            <button onclick="toggleLegend()" class="text-slate-400 hover:text-slate-600 transition-colors"><i
                    class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="mb-5">
            <h5 class="text-xs font-bold text-slate-800 mb-2 flex items-center"><i
                    class="fa-solid fa-shield-halved text-green-500 mr-2"></i>ì•ˆì‹¬ ì£¼ê±° ë“±ê¸‰</h5>
            <div class="grid grid-cols-2 gap-2">
                <div
                    class="flex items-center text-xs text-slate-600 bg-slate-50/50 p-1.5 rounded-lg border border-slate-100">
                    <span class="w-2.5 h-2.5 rounded-full bg-green-500 mr-2 shadow-sm"></span> A (ìƒìœ„ 15%)
                </div>
                <div
                    class="flex items-center text-xs text-slate-600 bg-slate-50/50 p-1.5 rounded-lg border border-slate-100">
                    <span class="w-2.5 h-2.5 rounded-full bg-yellow-400 mr-2 shadow-sm"></span> B (ì•ˆì‹¬)
                </div>
                <div
                    class="flex items-center text-xs text-slate-600 bg-slate-50/50 p-1.5 rounded-lg border border-slate-100">
                    <span class="w-2.5 h-2.5 rounded-full bg-orange-400 mr-2 shadow-sm"></span> C (ë³´í†µ)
                </div>
                <div
                    class="flex items-center text-xs text-slate-600 bg-slate-50/50 p-1.5 rounded-lg border border-slate-100">
                    <span class="w-2.5 h-2.5 rounded-full bg-red-500 mr-2 shadow-sm"></span> D (ì£¼ì˜)
                </div>
            </div>
        </div>

        <div>
            <h5 class="text-xs font-bold text-slate-800 mb-2 flex items-center"><i
                    class="fa-solid fa-map-pin text-blue-500 mr-2"></i>ë§¤ë¬¼ ìœ í˜• (ë§ˆì»¤)</h5>
            <div class="space-y-2">
                <div class="flex items-center text-xs text-slate-600 hover:bg-slate-50 p-1 rounded transition-colors">
                    <span
                        class="w-10 h-4 rounded px-1 text-[9px] text-white font-bold bg-[#3B82F6] mr-2 flex items-center justify-center shadow-sm">ì•„íŒŒíŠ¸</span>
                    APT (ì•„íŒŒíŠ¸)
                </div>
                <div class="flex items-center text-xs text-slate-600 hover:bg-slate-50 p-1 rounded transition-colors">
                    <span
                        class="w-10 h-4 rounded px-1 text-[9px] text-white font-bold bg-[#8B5CF6] mr-2 flex items-center justify-center shadow-sm">ì˜¤í”¼</span>
                    OP (ì˜¤í”¼ìŠ¤í…”)
                </div>
                <div class="flex items-center text-xs text-slate-600 hover:bg-slate-50 p-1 rounded transition-colors">
                    <span
                        class="w-10 h-4 rounded px-1 text-[9px] text-white font-bold bg-[#F97316] mr-2 flex items-center justify-center shadow-sm">ì—°ë¦½</span>
                    YH (ì—°ë¦½/ë‹¤ì„¸ëŒ€)
                </div>
                <div class="flex items-center text-xs text-slate-600 hover:bg-slate-50 p-1 rounded transition-colors">
                    <span
                        class="w-10 h-4 rounded px-1 text-[9px] text-white font-bold bg-[#22C55E] mr-2 flex items-center justify-center shadow-sm">ë‹¨ë…</span>
                    DD (ë‹¨ë…/ë‹¤ê°€êµ¬)
                </div>
            </div>
        </div>

        <div class="mt-4 pt-3 border-t border-slate-200/50">
            <h5 class="text-xs font-bold text-slate-800 mb-2 flex items-center"><i
                    class="fa-solid fa-layer-group text-slate-500 mr-2"></i>íŠ¹ìˆ˜ êµ¬ì—­ (GIS)</h5>
            <div class="space-y-1.5">
                <div class="flex items-center text-xs text-slate-600"><span
                        class="w-3 h-3 rounded-full bg-red-500/30 border border-red-500 mr-2"></span> ì†ŒìŒ/ìœ í•´ ì‹œì„¤ ì¸ì ‘</div>
                <div class="flex items-center text-xs text-slate-600"><span
                        class="w-3 h-3 rounded-full bg-purple-500/30 border border-purple-500 mr-2"></span> ì£¼ìš” í•™ì›ê°€/ìƒê¶Œ
                </div>
                <div class="flex items-center text-xs text-slate-600"><span
                        class="w-3 h-3 rounded-full bg-amber-800/40 border border-amber-800 mr-2"></span> ê¸‰ê²½ì‚¬(ì–¸ë•) êµ¬ê°„
                </div>
            </div>
        </div>
    </div>
    <script>
        // Mobile Menu Script (Moved from Header)
        const btn = document.getElementById('mobile-menu-btn');
        const menu = document.getElementById('mobile-menu');
        if (btn && menu) {
            btn.addEventListener('click', () => { menu.classList.toggle('hidden'); });
        }
    </script>

    <script>
        // --- 1. Data Generator ---
        const SILLIM_CENTER = { lat: 37.4842, lng: 126.9296 };
        const NAMES = {
            'APT': ['í‘¸ë¥´ì§€ì˜¤', 'í˜„ëŒ€ì•„íŒŒíŠ¸', 'ì‹ ë™ì•„', 'ì•„ì´íŒŒí¬', 'ë˜ë¯¸ì•ˆ', 'ìì´'],
            'OP': ['ë¥´ë„¤ìƒìŠ¤', 'ë©”íŠ¸ë¡œ', 'ë”ë¦¬ì¹˜', 'í”„ë¼ì„', 'ë…¸ë¸”ë ˆìŠ¤', 'ìŠ¤í…Œì´'],
            'YH': ['í–‰ë³µë¹Œ', 'ëŒ€ë°•ë¹Œë¼', 'ì²­ìš´ë¹Œë¼', 'í–‡ì‚´ê°€ë“', 'ë“œë¦¼ë¹Œ', 'ìŠ¤ìœ„íŠ¸'],
            'DD': ['ë‹¤ëª¨ì•„', 'í•´í”¼ë£¸', 'ë“œë¦¼íƒ€ìš´', 'ìˆ˜ëª©ì›', 'í’€í•˜ìš°ìŠ¤', 'ìŠ¤íƒ€ë¹Œ']
        };

        // GeoJSON Data Definitions (Polygons)
        const SeowonDongGeoJSON = {
            "type": "Feature",
            "properties": { "adm_cd": "11620xxx", "adm_nm": "ì„œì›ë™", "grade": "C", "is_target": false },
            "geometry": {
                "type": "Polygon",
                "coordinates": [[
                    [126.9250, 37.4850], [126.9300, 37.4850], [126.9310, 37.4830], [126.9280, 37.4820], [126.9250, 37.4850]
                ]]
            }
        };

        const SinwonDongGeoJSON = {
            "type": "Feature",
            "properties": { "adm_cd": "11620xxx", "adm_nm": "ì‹ ì›ë™", "grade": "B", "is_target": true }, // Target Zone
            "geometry": {
                "type": "Polygon",
                "coordinates": [[
                    [126.9280, 37.4820], [126.9310, 37.4830], [126.9320, 37.4810], [126.9290, 37.4800], [126.9280, 37.4820]
                ]]
            }
        };

        function generateMockCCTV(center, count) {
            const data = [];
            for (let i = 0; i < count; i++) {
                let lat = center.lat + (Math.random() - 0.5) * 0.01;
                let lng = center.lng + (Math.random() - 0.5) * 0.01;
                data.push({
                    id: `TN_CCTV_${i}`,
                    lat: lat,
                    lng: lng,
                    source: Math.random() > 0.8 ? 'National' : 'Seoul',
                    type: 'ë°©ë²”ìš©'
                });
            }
            return data;
        }

        // Global GIS Zones
        const mockNoiseZones = [
            { center: { lat: 37.481, lng: 126.925 }, radius: 250, label: 'ëŒ€ë¡œë³€ ì†ŒìŒ ì£¼ì˜' },
            { center: { lat: 37.485, lng: 126.921 }, radius: 150, label: 'ì² ë„ ì†ŒìŒ ì£¼ì˜' },
            { center: { lat: 37.488, lng: 126.932 }, radius: 300, label: 'ìƒì—…ì§€êµ¬ ì†ŒìŒ' }
        ];
        const mockAcademyZones = [
            { center: { lat: 37.495, lng: 127.061 }, radius: 500, type: 'ì…ì‹œ', label: 'ëŒ€ì¹˜ë™ í•™ì›ê°€' },
            { center: { lat: 37.649, lng: 127.076 }, radius: 400, type: 'ì–´í•™', label: 'ì¤‘ê³„ë™ ì€í–‰ì‚¬ê±°ë¦¬' }
        ];
        const mockHillZones = [
            { center: { lat: 37.475, lng: 126.935 }, radius: 500, label: 'ê´€ì•…ì‚° ë“±ì‚°ë¡œ' },
            { center: { lat: 37.485, lng: 126.915 }, radius: 400, label: 'ë‚œê³¡ íìŠ¤í…Œì´' }
        ];

        function generateMockListings(count) {
            const listings = [];
            for (let i = 0; i < count; i++) {
                // 1. Basic Info
                const type = ['APT', 'OP', 'YH', 'DD'][Math.floor(Math.random() * 4)];

                const name = (NAMES[type] ? NAMES[type][Math.floor(Math.random() * NAMES[type].length)] : 'ë¹Œë¼') +
                    " " + (Math.floor(Math.random() * 10) + 1) + "ì°¨";

                const dealType = Math.random() > 0.8 ? 'jeonse' : 'monthly';
                let floor = Math.floor(Math.random() * 15) + 1 + 'ì¸µ';

                let price = { d: 0, r: 0 };
                let size = 0;

                // Size & Price Logic based on Type
                if (type === 'DD') {
                    // ë‹¨ë…/ë‹¤ê°€êµ¬: ì›ë£¸(5~10í‰) vs ì£¼íƒ(20í‰~)
                    if (Math.random() > 0.6) size = Math.floor(Math.random() * 20) + 20;
                    else size = Math.floor(Math.random() * 6) + 5;
                } else if (type === 'YH') {
                    size = Math.floor(Math.random() * 15) + 10;
                } else if (type === 'OP') {
                    size = Math.floor(Math.random() * 10) + 6;
                } else {
                    size = Math.floor(Math.random() * 30) + 20; // APT
                }

                // Price Logic (Simplified)
                if (dealType === 'monthly') {
                    price.d = Math.floor(Math.random() * 5000) + 500;
                    price.r = Math.floor(Math.random() * 100) + 30;
                } else {
                    price.d = Math.floor(Math.random() * 30000) + 10000;
                    price.r = 0;
                }

                // Heating Logic (Method & Fuel)
                const heating = { method: '', fuel: '' };
                const hRand = Math.random();

                if (type === 'APT') {
                    if (hRand < 0.4) {
                        heating.method = 'ì§€ì—­ë‚œë°©';
                        heating.fuel = 'ì—´ë³‘í•©';
                    } else if (hRand < 0.8) {
                        heating.method = 'ê°œë³„ë‚œë°©';
                        heating.fuel = 'ë„ì‹œê°€ìŠ¤';
                    } else {
                        heating.method = 'ì¤‘ì•™ë‚œë°©';
                        heating.fuel = Math.random() > 0.5 ? 'ë„ì‹œê°€ìŠ¤' : 'ê¸°ë¦„';
                    }
                } else if (type === 'OP') {
                    if (hRand < 0.7) {
                        heating.method = 'ê°œë³„ë‚œë°©';
                        heating.fuel = 'ë„ì‹œê°€ìŠ¤';
                    } else {
                        heating.method = 'ì§€ì—­ë‚œë°©';
                        heating.fuel = 'ì—´ë³‘í•©';
                    }
                } else {
                    // YH, DD
                    if (hRand < 0.95) {
                        heating.method = 'ê°œë³„ë‚œë°©';
                        heating.fuel = 'ë„ì‹œê°€ìŠ¤';
                    } else {
                        heating.method = 'ê°œë³„ë‚œë°©';
                        heating.fuel = Math.random() > 0.5 ? 'ê¸°ë¦„' : 'LPG';
                    }
                }

                // 2. Scores & GIS Attributes (Slope, Noise, Infra)
                let slope = 0;
                // APT tends to be flatter (0~10), others wider range (0~25)
                if (type === 'APT') {
                    slope = Math.floor(Math.random() * 10);
                } else {
                    // 0~25 degrees
                    if (Math.random() < 0.3) slope = Math.floor(Math.random() * 5); // Flat
                    else if (Math.random() < 0.8) slope = Math.floor(Math.random() * 10) + 5; // Mild
                    else slope = Math.floor(Math.random() * 11) + 15; // Steep (15~25)
                }

                const noiseLevel = Math.floor(Math.random() * 41) + 40; // 40~80 dB
                const infraScore = Math.floor(Math.random() * 101); // 0~100

                const baseComfort = Math.floor(Math.random() * 40) + 60;
                // Comfort Score Penalty: if slope >= 10, -3 per degree
                let comfortPenalty = (slope >= 10) ? (slope * 3) : (slope * 2);
                const comfortScore = Math.max(10, baseComfort - comfortPenalty);

                // Environment Penalty: if noise >= 65, -20
                let envScore = Math.floor(Math.random() * 100);
                if (noiseLevel >= 65) envScore = Math.max(10, envScore - 20);

                const scores = {
                    traffic: Math.floor(Math.random() * 100),
                    living_infra: infraScore,
                    property_building: Math.floor(Math.random() * 60) + 40,
                    security_safety: Math.floor(Math.random() * 60) + 40,
                    living_comfort: Math.floor(comfortScore),
                    environment: envScore
                };

                const weightedScore =
                    (scores.traffic * 0.25) +
                    (scores.property_building * 0.25) +
                    (scores.living_infra * 0.15) +
                    (scores.security_safety * 0.15) +
                    (scores.living_comfort * 0.15) +
                    (scores.environment * 0.05);

                let grade = 'C';
                if (weightedScore >= 85) grade = 'A';
                else if (weightedScore >= 55) grade = 'B';
                else if (weightedScore >= 20) grade = 'C';
                else grade = 'D';

                // Feature Badges
                const features = [];
                if (slope < 5) features.push("ğŸŸ¢ ì™„ì „ í‰ì§€");
                if (slope > 15) features.push("ğŸ”´ ë“±ì‚° ì½”ìŠ¤");
                if (noiseLevel > 70) features.push("ğŸ”Š ì†ŒìŒ ì£¼ì˜");
                if (infraScore > 80) features.push("ğŸ§º ìŠ¬ì„¸ê¶Œ");

                // Generate SWOT Data
                const swot = generateSWOT({ scores, type, slope, price, noiseLevel, grade });

                // Adjust lat/lng slightly around center
                let lat = SILLIM_CENTER.lat + (Math.random() - 0.5) * 0.008;
                let lng = SILLIM_CENTER.lng + (Math.random() - 0.5) * 0.008;

                listings.push({
                    id: `L${i}`,
                    name: name,
                    lat: lat, lng: lng,
                    type: type, size: size, dealType: dealType, price: price, floor: floor,
                    zone: 'Safe', scores: scores, grade: grade, slope: slope,
                    noiseLevel: noiseLevel, infraScore: infraScore,
                    heating: heating, features: features, swot: swot,
                    reviewCount: Math.floor(Math.random() * 20),
                    rating: (Math.random() * 2 + 3).toFixed(1),
                    pros: "êµí†µ í¸ë¦¬, ë§ˆíŠ¸ ì¸ì ‘"
                });
            }
            return listings;
        }

        const Listings = generateMockListings(100);
        const MockCCTV = generateMockCCTV(SILLIM_CENTER, 50);
        // Type Names Mapping (MOLIT Standard)
        const TypeNames = { 'APT': 'ì•„íŒŒíŠ¸', 'OP': 'ì˜¤í”¼ìŠ¤í…”', 'YH': 'ì—°ë¦½/ë‹¤ì„¸ëŒ€', 'DD': 'ë‹¨ë…/ë‹¤ê°€êµ¬' };

        const TypeColors = {
            'APT': '#3B82F6', // Blue
            'OP': '#8B5CF6',  // Purple
            'YH': '#F97316',  // Orange
            'DD': '#22C55E'   // Green
        };

        // --- 2. Map & State ---
        let map;
        let mapObjects = { zones: [], markers: [], cctv: [], overlays: [] };
        let seoulData = null; // Global variable for loaded GeoJSON
        let filterState = {
            types: new Set(['APT', 'OP', 'YH', 'DD']),
            size: 'all',
            dealType: 'monthly',
            grades: new Set(['A', 'B', 'C', 'D']),
            budget: { depMin: 0, depMax: 999999, rentMin: 0, rentMax: 999999 }
        };

        // New layer visibility state
        let isPolygonVisible = true; // Kept for compatibility if needed, but grades set controls visibility now
        let isMarkerVisible = true;
        let isReviewVisible = false; // Toggle state
        let isCctvVisible = false;

        let filteredData = [];
        let visibleCount = 20;

        let currentViewMode = 'total';
        let isPyeong = true; // Unit State
        let chartInstance = null; // Chart instance

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            // Initial List Render
            renderInitialList();
        });

        // --- Functions ---
        function generateSWOT(item) {
            const s = [], w = [], o = [], t = [];

            // Strengths (Scores > 80)
            if (item.scores.traffic > 80) s.push("ì§€í•˜ì² ì—­ ë„ë³´ 5ë¶„ ì´ˆì—­ì„¸ê¶Œ");
            if (item.scores.living_comfort > 80) s.push("ìˆ²ì„¸ê¶Œ/íŒì„¸ê¶Œ ì¾Œì í•¨");
            if (item.scores.living_infra > 80) s.push("ëŒ€í˜•ë§ˆíŠ¸/ë°±í™”ì  ìŠ¬ì„¸ê¶Œ");
            if (item.type === 'YH' && item.price.d < 20000) s.push("ì„œìš¸ì—ì„œ ë³´ê¸° ë“œë¬¸ ê°€ì„±ë¹„");
            if (item.slope < 5) s.push("í‰ì§€ë¼ ì´ë™ì´ í¸ë¦¬í•´ìš”");

            // Weaknesses (Scores < 50)
            if (item.scores.traffic < 50) w.push("ì§€í•˜ì² ì—­ê¹Œì§€ ë§ˆì„ë²„ìŠ¤ í•„ìš”");
            if (item.scores.property_building < 50) w.push("ê±´ë¬¼ ë…¸í›„í™”ë¡œ ì£¼ì°¨ ë‚œí•­ ì˜ˆìƒ");
            if (item.slope > 10) w.push("ë§¤ì¼ ìš´ë™ë˜ëŠ” ì˜¤ë¥´ë§‰ê¸¸");
            if (item.noiseLevel > 65) w.push("ì£¼ë³€ ì†ŒìŒìœ¼ë¡œ ì°½ë¬¸ ì—´ê¸° ë¶€ë‹´");

            // Opportunities (External Factors)
            if (item.type === 'YH' || item.type === 'DD') {
                o.push("ëª¨ì•„íƒ€ìš´/ì‹ ì†í†µí•©ê¸°íš í›„ë³´ì§€ ê°€ëŠ¥ì„±");
                o.push("ê²½ì „ì²  ì„œë¶€ì„  ê°œí†µ í˜¸ì¬");
            } else {
                o.push("ì£¼ë³€ ìƒê¶Œ ë¦¬ëª¨ë¸ë§ í™œë°œ");
            }
            if (item.grade === 'C' || item.grade === 'D') o.push("ì €í‰ê°€ ì§€ì—­ìœ¼ë¡œ ì‹œì„¸ ìƒìŠ¹ ì—¬ë ¥");

            // Threats (External Risks)
            if (item.scores.traffic > 90) t.push("ì„ëŒ€ì°¨ ê°±ì‹  ì‹œ ë³´ì¦ê¸ˆ ì¸ìƒ ìœ ë ¥");
            else t.push("ì¸ê·¼ ê³µì‚¬ë¡œ ë‹¹ë¶„ê°„ ì†ŒìŒ ì˜ˆìƒ");
            if (item.scores.security_safety < 60) t.push("ë°¤ê¸¸ ê·€ê°€ ì‹œ ì£¼ì˜ í•„ìš”");

            // Fill empty slots if needed to ensure at least 1 item
            if (s.length === 0) s.push("ë¬´ë‚œí•˜ê³  ì¡°ìš©í•œ ì£¼ê±° í™˜ê²½");
            if (w.length === 0) w.push("íŠ¹ë³„í•œ ë‹¨ì ì´ ì—†ëŠ” ê²ƒì´ ì¥ì ");

            return { s: s.slice(0, 2), w: w.slice(0, 2), o: o.slice(0, 2), t: t.slice(0, 2) };
        }

        // Helper: Calculate Grade based on View Mode
        function getGrade(item, mode) {
            let score = 0;
            // Mode mapping
            if (mode === 'total') {
                // Approximate weighted score if not pre-calculated
                if (item.grade === 'A') score = 90;
                else if (item.grade === 'B') score = 70;
                else if (item.grade === 'C') score = 40;
                else score = 10;
                // If polygon has explicit scores, use weighted average
                if (item.scores) {
                    score = (item.scores.traffic * 0.25) + (item.scores.property_building * 0.25) +
                        (item.scores.living_infra * 0.15) + (item.scores.security_safety * 0.15) +
                        (item.scores.living_comfort * 0.15) + (item.scores.environment * 0.05);
                }
            } else {
                if (!item.scores) return 'C';
                if (mode === 'security') score = item.scores.security_safety;
                else if (mode === 'building') score = item.scores.property_building;
                else if (mode === 'comfort') score = item.scores.living_comfort;
                else if (mode === 'infra') score = item.scores.living_infra;
                else if (mode === 'traffic') score = item.scores.traffic;
                else if (mode === 'env') score = item.scores.environment;
            }

            if (score >= 85) return 'A';
            if (score >= 55) return 'B';
            if (score >= 20) return 'C';
            return 'D';
        }

        function getRegionColor(grade) {
            if (grade === 'A') return '#22c55e'; // Green
            if (grade === 'B') return '#eab308'; // Yellow
            if (grade === 'C') return '#f97316'; // Orange
            return '#ef4444'; // Red
        }

        function renderSpecialLayers() {
            // 1. Noise Zones (Red)
            mockNoiseZones.forEach(zone => {
                const circle = new kakao.maps.Circle({
                    center: new kakao.maps.LatLng(zone.center.lat, zone.center.lng),
                    radius: zone.radius,
                    strokeWeight: 0,
                    fillColor: '#FF0000',
                    fillOpacity: 0.3
                });
                circle.setMap(null); // Default Off
                circle.customType = 'noise'; // Add Type Identifier
                mapObjects.overlays.push(circle);

                const label = new kakao.maps.CustomOverlay({
                    position: new kakao.maps.LatLng(zone.center.lat, zone.center.lng),
                    content: `<div class="bg-red-500 text-white text-[10px] px-2 py-1 round-full shadow-md font-bold flex items-center gap-1 opacity-90" style="border-radius: 9999px;">
                                <i class="fa-solid fa-volume-high"></i> ${zone.label}
                              </div>`,
                    yAnchor: 1.5
                });
                label.setMap(null); // Default Off
                label.customType = 'noise';
                mapObjects.overlays.push(label);
            });

            // 2. Academy Zones (Purple)
            mockAcademyZones.forEach(zone => {
                const circle = new kakao.maps.Circle({
                    center: new kakao.maps.LatLng(zone.center.lat, zone.center.lng),
                    radius: zone.radius,
                    strokeWeight: 0,
                    fillColor: '#8B5CF6',
                    fillOpacity: 0.3
                });
                circle.setMap(null); // Default Off
                circle.customType = 'academy';
                mapObjects.overlays.push(circle);

                const label = new kakao.maps.CustomOverlay({
                    position: new kakao.maps.LatLng(zone.center.lat, zone.center.lng),
                    content: `<div class="bg-purple-600 text-white text-[10px] px-2 py-1 round-full shadow-md font-bold flex items-center gap-1 opacity-90" style="border-radius: 9999px;">
                                <i class="fa-solid fa-graduation-cap"></i> ${zone.label}
                              </div>`,
                    yAnchor: 1.5
                });
                label.setMap(null); // Default Off
                label.customType = 'academy';
                mapObjects.overlays.push(label);
            });

            // 3. Hill Zones (Brown)
            mockHillZones.forEach(zone => {
                const circle = new kakao.maps.Circle({
                    center: new kakao.maps.LatLng(zone.center.lat, zone.center.lng),
                    radius: zone.radius,
                    strokeWeight: 0,
                    fillColor: '#78350F',
                    fillOpacity: 0.4
                });
                circle.setMap(null); // Default Off
                circle.customType = 'hill';
                mapObjects.overlays.push(circle);

                const label = new kakao.maps.CustomOverlay({
                    position: new kakao.maps.LatLng(zone.center.lat, zone.center.lng),
                    content: `<div class="bg-amber-800 text-white text-[10px] px-2 py-1 round-full shadow-md font-bold flex items-center gap-1 opacity-90" style="border-radius: 9999px;">
                                <i class="fa-solid fa-mountain"></i> ${zone.label}
                              </div>`,
                    yAnchor: 1.5
                });
                label.setMap(null); // Default Off
                label.customType = 'hill';
                mapObjects.overlays.push(label);
            });
        }

        function toggleSpecialLayer(type, isVisible) {
            mapObjects.overlays.forEach(overlay => {
                if (overlay.customType === type) {
                    overlay.setMap(isVisible ? map : null);
                }
            });
        }

        function renderInitialList() {
            const listContainer = document.getElementById('sidebar-content');
            // Inject Layout
            listContainer.innerHTML = `
                <div class="flex items-center justify-between mb-3 px-1 sticky top-0 bg-slate-50 z-10 py-1">
                    <span class="text-xs font-bold text-slate-500">ê²€ìƒ‰ ê²°ê³¼ <span id="result-count" class="text-blue-600">0</span>ê±´</span>
                    <button onclick="resetFilters()" class="text-xs text-slate-400 underline hover:text-slate-600">ì´ˆê¸°í™”</button>
                </div>
                
                <!-- Top 3 Recommendation (Dynamic) -->
                <div id="top-recommendation" class="hidden mb-4 bg-gradient-to-br from-indigo-50 to-blue-50 border border-indigo-100 rounded-xl p-4">
                     <h3 class="text-sm font-bold text-indigo-800 mb-3 flex items-center">
                        <i class="fa-solid fa-crown text-yellow-500 mr-2"></i>
                        <span id="top-title">000ë‹˜</span>ì´ ì„ í˜¸í•˜ëŠ” ë™ë„¤ TOP 3
                     </h3>
                     <div id="top-list" class="space-y-2"></div>
                </div>

                <div id="result-list" class="space-y-3 pb-8"></div>
                <div id="loading-indicator" class="hidden text-center py-4 text-xs text-slate-400">
                    <i class="fa-solid fa-spinner fa-spin mr-1"></i> ë” ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
             `;
        }

        function initMap() {
            const container = document.getElementById('map');
            const options = { center: new kakao.maps.LatLng(SILLIM_CENTER.lat, SILLIM_CENTER.lng), level: 4 };
            map = new kakao.maps.Map(container, options);

            // --- Robust Data Load (No Fetch) ---
            kakao.maps.load(() => {
                console.log("[Init] Loading Mock Data directly...");

                // DIRECT ASSIGNMENT
                seoulData = {
                    "type": "FeatureCollection",
                    "features": [SeowonDongGeoJSON, SinwonDongGeoJSON]
                };

                // Inject Mock Scores into Polygon Features for Coloring
                seoulData.features.forEach(f => {
                    if (!f.properties.scores) {
                        // Generate random scores consistent with existing mock data logic
                        f.properties.scores = {
                            traffic: Math.floor(Math.random() * 40) + 60,
                            living_infra: Math.floor(Math.random() * 40) + 60,
                            property_building: Math.floor(Math.random() * 40) + 60,
                            security_safety: Math.floor(Math.random() * 40) + 60,
                            living_comfort: Math.floor(Math.random() * 40) + 60,
                            environment: Math.floor(Math.random() * 40) + 60
                        };
                    }
                });

                // Personalization Check
                const params = new URLSearchParams(window.location.search);
                const personaId = params.get('persona') || params.get('type') || params.get('preset');

                if (personaId && typeof applyPersonalization === 'function') {
                    applyPersonalization(seoulData, personaId);
                }

                // Draw Polygon Immediately
                drawPolygons(seoulData);

                // Hide Map Loader
                const loader = document.getElementById('map-loader');
                if (loader) loader.classList.add('hidden');

                // Render Special Zones
                renderSpecialLayers();
            });

            if (typeof applyFilter === 'function') applyFilter();
            if (typeof updateLayerToggles === 'function') updateLayerToggles();

            // Zoom Event for Detail Data
            kakao.maps.event.addListener(map, 'zoom_changed', () => {
                const level = map.getLevel();
                if (typeof toggleDetailLayers === 'function') toggleDetailLayers(level);
            });
        }

        function toggleDetailLayers(level) {
            // Level 1,2,3 -> Show Detail (CCTV)
            if (level <= 3) {
                if (mapObjects.cctv.length === 0 && seoulData) {
                    renderDetailMarkers();
                } else {
                    showCCTVMarkers(true);
                }
            } else {
                showCCTVMarkers(false);
            }
        }

        function renderDetailMarkers() {
            if (!seoulData) return;

            seoulData.features.forEach(feature => {
                const props = feature.properties;
                // Only render if target and has detail data
                if (props.is_target && props.detail_data && props.detail_data.cctv) {
                    props.detail_data.cctv.forEach(coord => {
                        // coord is [lng, lat]
                        const position = new kakao.maps.LatLng(coord[1], coord[0]);

                        // Create Custom Overlay for better aesthetics
                        const content = document.createElement('div');
                        content.className = 'cctv-marker';
                        content.innerHTML = '<i class="fa-solid fa-video text-white text-xs"></i>';

                        const overlay = new kakao.maps.CustomOverlay({
                            position: position,
                            content: content,
                            yAnchor: 1
                        });

                        overlay.setMap(map);
                        mapObjects.cctv.push(overlay);
                    });
                }
            });
        }

        function showCCTVMarkers(visible) {
            mapObjects.cctv.forEach(overlay => {
                overlay.setMap(visible ? map : null);
            });
        }

        // Async Data Fetching
        async function fetchSeoulData() {
            try {
                const response = await fetch('data/seoul_hybrid_data.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                console.log("Seoul Hybrid Data Loaded:", data);
                return data;
            } catch (error) {
                console.warn("Failed to load Seoul data. Rendering empty map.", error);
                // Return minimal empty struct or null to avoid crash
                return null;
            }
        }

        function drawPolygons(geoJSON) {
            if (!geoJSON || !geoJSON.features) return;

            geoJSON.features.forEach(feature => {
                const props = feature.properties;
                const coords = feature.geometry.coordinates[0]; // Assuming Polygon type, taking first ring

                // Convert GeoJSON [lng, lat] to Kakao LatLng
                const path = coords.map(c => new kakao.maps.LatLng(c[1], c[0]));

                // New Logic: determine grade dynamically based on view mode
                const dynamicGrade = getGrade(props, currentViewMode);
                let fillColor = getRegionColor(dynamicGrade);

                // Target Zone Styling
                let strokeColor = fillColor;
                let strokeWeight = 1; // Default lightweight
                let setOpacity = 0.4; // Default 0.4 for better visibility of color

                if (props.is_target) {
                    strokeWeight = 3;
                    strokeColor = '#1e3a8a'; // Dark Blue (blue-900) for emphasis
                    setOpacity = 0.6; // Slightly more visible
                }

                const polygon = new kakao.maps.Polygon({
                    path: path,
                    strokeWeight: strokeWeight,
                    strokeColor: strokeColor,
                    strokeOpacity: 1,
                    fillOpacity: setOpacity,
                    fillColor: fillColor,
                    zIndex: props.is_target ? 10 : 1
                });

                // Store grade for filtering/reference
                polygon.customData = { grade: dynamicGrade };

                polygon.setMap(map);

                // Events
                kakao.maps.event.addListener(polygon, 'mouseover', () => polygon.setOptions({ fillOpacity: 0.7 }));
                kakao.maps.event.addListener(polygon, 'mouseout', () => polygon.setOptions({ fillOpacity: setOpacity }));
                kakao.maps.event.addListener(polygon, 'click', () => {
                    if (props.is_target) {
                        props.scores = {
                            security_safety: 90, property_building: 85, living_comfort: 80,
                            living_infra: 95, traffic: 70, environment: 60
                        };
                        showZoneDetail(props);
                    } else {
                        showToast("ğŸš§ ìƒì„¸ ë¶„ì„ ì¤€ë¹„ ì¤‘ì¸ ì§€ì—­ì…ë‹ˆë‹¤. (ì•ˆì‹¬ ë“±ê¸‰ë§Œ ì œê³µ)");
                    }
                });

                mapObjects.zones.push(polygon);
            });
        }

        function changeViewMode(mode) {
            currentViewMode = mode;
            // Clear existing polygons
            mapObjects.zones.forEach(z => z.setMap(null));
            mapObjects.zones = [];
            // Redraw with new mode
            drawPolygons(seoulData);
            // Re-apply filter to update list items if needed (though list items filter by grade, which might be confusing if grade definition changes. For now let's keep list filters independent or aligned. 
            // The request says "Filter Linkage: A-D grade filter should work with the category". 
            // So we should re-apply filter because getGrade is used there? Wait, listings have their own scores. 
            // Let's ensure list filtering also respects the mode if desired, but request emphasized "Polygon Coloring". 
            // However, "Filter Linkage" implies if I select "Traffic" and "Grade A", I expect to see Traffic Grade A items.
            applyFilter();
        }

        // --- 3. Filter Logic ---
        function setDealType(type) {
            filterState.dealType = type;
            document.querySelectorAll('.deal-toggle-btn').forEach(b => b.classList.remove('active', 'bg-white', 'text-blue-600', 'shadow-sm'));
            document.getElementById(`deal-${type}`).classList.add('active', 'bg-white', 'text-blue-600', 'shadow-sm');
            applyFilter();
        }

        function toggleType(type) {
            if (filterState.types.has(type)) { if (filterState.types.size > 1) filterState.types.delete(type); }
            else filterState.types.add(type);

            document.querySelectorAll('.filter-type-btn').forEach(btn => {
                const t = btn.dataset.type;
                if (filterState.types.has(t)) {
                    btn.classList.add('active', 'bg-blue-600', 'text-white', 'border-blue-600');
                    btn.classList.remove('bg-gray-50', 'text-slate-500', 'border-slate-200');
                } else {
                    btn.classList.remove('active', 'bg-blue-600', 'text-white', 'border-blue-600');
                    btn.classList.add('bg-gray-50', 'text-slate-500', 'border-slate-200');
                }
            });
            applyFilter();
        }

        function setSize(size) {
            filterState.size = size;
            document.querySelectorAll('.filter-size-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-50', 'text-blue-600', 'border-blue-600');
                btn.classList.add('text-slate-500', 'border-slate-200');
                if (btn.dataset.size === size) {
                    btn.classList.add('active', 'bg-blue-50', 'text-blue-600', 'border-blue-600');
                    btn.classList.remove('text-slate-500', 'border-slate-200');
                }
            });
            applyFilter();
        }

        // Bridge to new helper
        function formatPrice(price) {
            return formatMoney(price.d, price.r);
        }

        // Helper: Format Money (Eok/Man)
        function formatMoney(d, r) {
            let dStr = '';
            if (d >= 10000) {
                const eok = Math.floor(d / 10000);
                const man = d % 10000;
                dStr = `${eok}${man > 0 ? '.' + (man / 1000).toFixed(0) : ''}ì–µ`;
            } else if (d > 0) {
                dStr = `${d.toLocaleString()}ë§Œ`;
            } else {
                dStr = '0';
            }

            if (r > 0) return `${dStr} / ${r}ë§Œ`; // Monthly
            return dStr; // Jeonse
        }

        // Helper: Format Area
        function formatArea(sizePyeong) {
            if (isPyeong) return `${sizePyeong}í‰`;
            const m2 = (sizePyeong * 3.3058).toFixed(1); // 1 Pyeong approx 3.3058 m2
            return `${m2}ã¡`;
        }

        function toggleUnit() {
            isPyeong = !isPyeong;
            // Update Toggle UI
            const pyEl = document.getElementById('unit-pyeong');
            const m2El = document.getElementById('unit-m2');
            if (isPyeong) {
                pyEl.className = 'text-blue-600';
                m2El.className = 'text-slate-400';
            } else {
                pyEl.className = 'text-slate-400';
                m2El.className = 'text-blue-600';
            }
            // Re-render markers with new unit
            renderMarkers(filteredData);
        }

        function applyFilter() {
            document.getElementById('map-loader').classList.remove('hidden');

            setTimeout(() => {
                // 1. Filter Data
                filteredData = Listings.filter(item => {
                    if (!filterState.types.has(item.type)) return false;
                    if (item.dealType !== filterState.dealType) return false;
                    const s = item.size;
                    if (filterState.size === 'under10' && s >= 10) return false;
                    if (filterState.size === '10to20' && (s < 10 || s >= 20)) return false;
                    if (filterState.size === 'over30' && s < 30) return false;

                    // Grade Filter (Dynamic based on View Mode)
                    const itemGrade = getGrade(item, currentViewMode);
                    if (!filterState.grades.has(itemGrade)) return false;

                    // Budget Check
                    const d = item.price.d; // Deposit
                    const r = item.price.r; // Rent
                    const b = filterState.budget;

                    // Update budget state from inputs before filter (Sync)
                    const depMinInput = document.getElementById('budget-dep-min');
                    const depMaxInput = document.getElementById('budget-dep-max');
                    const rentMinInput = document.getElementById('budget-rent-min');
                    const rentMaxInput = document.getElementById('budget-rent-max');

                    if (depMinInput) b.depMin = parseInt(depMinInput.value) || 0;
                    if (depMaxInput) b.depMax = parseInt(depMaxInput.value) || 999999;
                    if (rentMinInput) b.rentMin = parseInt(rentMinInput.value) || 0;
                    if (rentMaxInput) b.rentMax = parseInt(rentMaxInput.value) || 999999;

                    if (d < b.depMin || d > b.depMax) return false;
                    if (r < b.rentMin || r > b.rentMax) return false;

                    return true;
                });

                document.getElementById('result-count').innerText = filteredData.length;

                // 2. Clear Markers
                mapObjects.markers.forEach(m => m.setMap(null));
                mapObjects.markers = [];

                // 3. Render Markers (New Grouped Logic)
                if (isMarkerVisible) {
                    renderMarkers(filteredData);
                }

                // 4. Render List
                visibleCount = 20;
                renderList();
                renderDataGrid(); // Sync Data Grid

                document.getElementById('map-loader').classList.add('hidden');
            }, 50);
        }

        function renderMarkers(items) {
            // Group by Coordinates (Lat,Lng Key)
            const groups = {};
            items.forEach(item => {
                const key = `${item.lat},${item.lng}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push(item);
            });

            // Iterate Groups to create Markers
            Object.values(groups).forEach(group => {
                const item = group[0]; // Representative Item
                const count = group.length;

                // Review Mode Logic
                if (isReviewVisible) {
                    if (item.reviewCount === 0) return;
                    // Grouping not applied to review markers in this request, but let's keep it simple (1 dot per location)
                    // If existing logic for review was per-item, grouping might hide separate reviews. 
                    // But strictly, stacking applies to "Markers". 
                    // Let's assume Review Mode also benefits from stacking or just render as is?
                    // Request focused on "Marker Design Improvement" (Price/Area). 
                    // Review markers are different. Let's keep Review Mode simple for now (per item) OR apply stacking if desired.
                    // IMPORTANT: The request says "Marker Stacking... badge". This likely applies to the main Listing Markers.
                    // I will apply stacking to standard markers. For Review markers, I'll stick to 1 representative or stack if needed. 
                    // Let's stick to STACKING for both to prevent overlap chaos.

                    const content = document.createElement('div');
                    content.className = `listing-marker bg-purple-600 border-purple-600`;
                    content.style.backgroundColor = '#9333ea';
                    content.style.borderColor = '#9333ea';

                    // Badge for Review Mode? Usually Review Mode shows "Score". 
                    // Let's just show the top rated one? Or average? 
                    // For safety, let's keep Review Mode logic separate and just iterate items IF we don't want stacking there.
                    // But lat/lng duplication means they overlap anyway. Grouping is better.

                    const style = document.createElement('style');
                    style.innerHTML = `.listing-marker.bg-purple-600::after { border-top-color: #9333ea !important; }`;
                    content.appendChild(style);
                    content.innerHTML = `<span>â˜… ${item.rating} (${item.reviewCount})</span>`;
                    // Badge
                    if (count > 1) {
                        const badge = document.createElement('span');
                        badge.className = 'absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border border-white shadow-sm z-50';
                        badge.innerText = `+${count - 1}`;
                        content.appendChild(badge);
                    }
                    content.onclick = () => showDetail(item); // Show first

                    const overlay = new kakao.maps.CustomOverlay({
                        map: map, position: new kakao.maps.LatLng(item.lat, item.lng),
                        content: content, yAnchor: 1, zIndex: 30
                    });
                    mapObjects.markers.push(overlay);

                } else {
                    // Standard Marker (Price / Area)
                    const markerColor = TypeColors[item.type] || '#3B82F6';

                    const content = document.createElement('div');
                    content.className = 'relative group cursor-pointer transition-transform hover:z-50 hover:scale-105';

                    // Main Box
                    const box = document.createElement('div');
                    box.className = 'rounded-xl shadow-md border-2 border-white flex flex-col items-center justify-center overflow-hidden';
                    box.style.backgroundColor = markerColor;
                    box.style.minWidth = '70px';

                    const priceText = formatMoney(item.price.d, item.price.r);
                    const areaText = formatArea(item.size);

                    box.innerHTML = `
                        <div class="px-2 py-1 text-white text-xs font-bold leading-none bg-black/10 w-full text-center">
                            ${priceText}
                        </div>
                        <div class="px-2 py-0.5 bg-white w-full text-center">
                             <span class="text-[10px] font-bold text-slate-600">${areaText}</span>
                        </div>
                    `;

                    // Stack Badge
                    if (count > 1) {
                        const badge = document.createElement('div');
                        badge.className = 'absolute -top-2 -right-2 bg-red-600 text-white text-[9px] font-bold w-5 h-5 flex items-center justify-center rounded-full border border-white shadow-sm z-10';
                        badge.innerText = `+${count - 1}`;
                        content.appendChild(badge);
                    }

                    content.appendChild(box);
                    content.onclick = () => showDetail(item);

                    const overlay = new kakao.maps.CustomOverlay({
                        map: map, position: new kakao.maps.LatLng(item.lat, item.lng),
                        content: content, yAnchor: 1, zIndex: 20
                    });
                    mapObjects.markers.push(overlay);
                }
            });
        }

        function renderDataGrid() {
            const tbody = document.getElementById('data-grid-body');
            tbody.innerHTML = '';

            // Show only first 50 for performance in grid for now
            const items = filteredData.slice(0, 50);
            document.getElementById('grid-count').innerText = filteredData.length;

            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 cursor-pointer transition-colors group";
                tr.onclick = () => {
                    map.panTo(new kakao.maps.LatLng(item.lat, item.lng));
                    showDetail(item);
                };

                const priceText = formatPrice(item.price);
                const gradeBadge = item.grade === 'A' || item.grade === 'B'
                    ? `<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-[10px] font-bold">ì•ˆì‹¬</span>`
                    : `<span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full text-[10px] font-bold">ì£¼ì˜</span>`;

                tr.innerHTML = `
                    <td class="px-4 py-3 text-center align-middle border-r border-gray-50">${gradeBadge}</td>
                    <td class="px-4 py-3 font-bold text-gray-900 group-hover:text-blue-600 transition-colors truncate max-w-[150px] border-r border-gray-50">${item.name}</td>
                    <td class="px-4 py-3 text-center text-xs font-medium text-gray-500 bg-gray-50/50 border-r border-gray-50">${TypeNames[item.type]}</td>
                    <td class="px-4 py-3 text-right font-mono font-medium text-blue-600 border-r border-gray-50">${priceText}</td>
                    <td class="px-4 py-3 text-right text-xs text-gray-500 border-r border-gray-50">${item.size}í‰ <span class="text-gray-300">|</span> ${item.floor}</td>
                    <td class="px-4 py-3 text-right text-xs text-gray-400 font-mono">2024.01.12</td>
                `;
                tbody.appendChild(tr);
            });

            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400 text-xs">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            }
        }

        let isGridExpanded = false;
        function toggleGrid() {
            const panel = document.getElementById('data-grid-panel');
            const icon = document.getElementById('grid-toggle-icon');
            if (isGridExpanded) {
                // Collapse to header height
                panel.style.height = '40px';
                panel.classList.add('h-10'); // Ensure class sync if needed, though style overrides
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                panel.style.height = '300px';
                panel.classList.remove('h-10');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
            isGridExpanded = !isGridExpanded;
        }

        function toggleLayerPanel() {
            const panel = document.getElementById('layer-options-panel');
            panel.classList.toggle('hidden');
        }

        function renderList() {
            const listContainer = document.getElementById('result-list');
            const itemsToShow = filteredData.slice(0, visibleCount);
            listContainer.innerHTML = ''; // Clear current list

            if (itemsToShow.length === 0) {
                listContainer.innerHTML = `<div class="p-8 text-center text-slate-400 text-sm">ì¡°ê±´ì— ë§ëŠ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            itemsToShow.forEach(item => {
                const priceText = formatPrice(item.price);
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:border-blue-400 cursor-pointer transition-all";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded">${TypeNames[item.type]}</span>
                        <span class="text-sm font-bold text-blue-600">${priceText}</span>
                    </div>
                    <h3 class="text-sm font-bold text-slate-900 truncate mb-1">${item.name}</h3>
                    <p class="text-xs text-slate-500">${item.size}í‰ Â· ${item.floor}</p>
                 `;
                card.onclick = () => {
                    map.panTo(new kakao.maps.LatLng(item.lat, item.lng));
                    showDetail(item);
                    if (window.innerWidth < 768) toggleSidebar(false); // On mobile, stay on map logic differs, but here clicking listing should probably show detail.
                };
                listContainer.appendChild(card);
            });

            const loader = document.getElementById('loading-indicator');
            if (filteredData.length > visibleCount) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        function handleScroll(target) {
            if (target.scrollTop + target.clientHeight >= target.scrollHeight - 50) {
                if (visibleCount < filteredData.length) {
                    visibleCount += 20;
                    appendListItems();
                }
            }
        }

        function appendListItems() {
            const listContainer = document.getElementById('result-list');
            const nextItems = filteredData.slice(visibleCount - 20, visibleCount);

            nextItems.forEach(item => {
                const priceText = formatPrice(item.price);
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:border-blue-400 cursor-pointer transition-all";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded">${TypeNames[item.type]}</span>
                        <span class="text-sm font-bold text-blue-600">${priceText}</span>
                    </div>
                    <h3 class="text-sm font-bold text-slate-900 truncate mb-1">${item.name}</h3>
                    <p class="text-xs text-slate-500">${item.size}í‰ Â· ${item.floor}</p>
                 `;
                card.onclick = () => {
                    map.panTo(new kakao.maps.LatLng(item.lat, item.lng));
                    showDetail(item);
                };
                listContainer.appendChild(card);
            });
        }

        function resetFilters() {
            filterState = {
                types: new Set(['APT', 'OP', 'YH', 'DD']),
                size: 'all',
                dealType: 'monthly',
                grades: new Set(['A', 'B', 'C', 'D']),
                budget: { depMin: 0, depMax: 999999, rentMin: 0, rentMax: 999999 }
            };
            setDealType('monthly');
            setSize('all');
            document.querySelectorAll('.filter-type-btn').forEach(btn => {
                btn.classList.add('active', 'bg-blue-600', 'text-white', 'border-blue-600');
                btn.classList.remove('bg-gray-50', 'text-slate-500', 'border-slate-200');
            });

            // Reset Budget Inputs
            ['budget-dep-min', 'budget-dep-max', 'budget-rent-min', 'budget-rent-max'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });

            // Reset Grade Toggles (All On)
            ['A', 'B', 'C', 'D'].forEach(g => {
                const btn = document.getElementById(`btn-grade-${g}`);
                if (btn) btn.classList.remove('opacity-50');
            });

            applyFilter();
        }

        // --- Layer & Detail Logic ---
        function toggleLayer(type) {
            if (type === 'polygon') {
                isPolygonVisible = !isPolygonVisible;
                mapObjects.zones.forEach(z => z.setMap(isPolygonVisible ? map : null));
            } else if (type === 'marker') {
                if (isReviewVisible) {
                    // If switching to marker, turn off review
                    isReviewVisible = false;
                    isMarkerVisible = true;
                } else {
                    isMarkerVisible = !isMarkerVisible;
                }
                applyFilter();
            } else if (type === 'review') {
                isReviewVisible = !isReviewVisible;
                if (isReviewVisible) isMarkerVisible = true; // Ensure markers are on if review is toggled
                applyFilter();
            } else if (type === 'cctv') {
                isCctvVisible = !isCctvVisible;

                if (isCctvVisible) {
                    // Render CCTV markers
                    MockCCTV.forEach(cctv => {
                        const content = document.createElement('div');
                        content.className = "w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center shadow-md border-2 border-white transform hover:scale-110 transition-transform";
                        content.innerHTML = `<i class="fa-solid fa-video text-[10px] text-white"></i>`;

                        const overlay = new kakao.maps.CustomOverlay({
                            map: map,
                            position: new kakao.maps.LatLng(cctv.lat, cctv.lng),
                            content: content,
                            yAnchor: 0.5,
                            zIndex: 10 // Above polygon(1), Below markers(20)
                        });
                        mapObjects.cctv.push(overlay);
                    });
                } else {
                    // Remove CCTV markers
                    mapObjects.cctv.forEach(o => o.setMap(null));
                    mapObjects.cctv = [];
                }
            }
            updateLayerToggles();
        }

        function updateLayerToggles() {
            const polygonBtn = document.getElementById('btn-toggle-polygon');
            const markerBtn = document.getElementById('btn-toggle-marker');
            const reviewBtn = document.getElementById('btn-toggle-review');
            const cctvBtn = document.getElementById('btn-toggle-cctv');

            // Polygon Toggle Style Logic Removed (Replaced by specific Grade Toggles)
            /*
            if (isPolygonVisible) {
                polygonBtn.classList.remove('bg-gray-200');
                polygonBtn.classList.add('bg-blue-600');
                polygonBtn.firstElementChild.classList.add('translate-x-5');
            } else {
                polygonBtn.classList.remove('bg-blue-600');
                polygonBtn.classList.add('bg-gray-200');
                polygonBtn.firstElementChild.classList.remove('translate-x-5');
            }
            */

            // Marker Toggle Style
            if (isMarkerVisible && !isReviewVisible) {
                markerBtn.classList.remove('bg-gray-200');
                markerBtn.classList.add('bg-blue-600');
                markerBtn.firstElementChild.classList.add('translate-x-5');
            } else {
                markerBtn.classList.remove('bg-blue-600');
                markerBtn.classList.add('bg-gray-200');
                markerBtn.firstElementChild.classList.remove('translate-x-5');
            }

            // Review Toggle Style
            if (isReviewVisible) {
                reviewBtn.classList.remove('bg-gray-200');
                reviewBtn.classList.add('bg-purple-600');
                reviewBtn.firstElementChild.classList.add('translate-x-5');
            } else {
                reviewBtn.classList.remove('bg-purple-600');
                reviewBtn.classList.add('bg-gray-200');
                reviewBtn.firstElementChild.classList.remove('translate-x-5');
            }

            // CCTV Toggle Style
            if (isCctvVisible) {
                cctvBtn.classList.remove('bg-gray-200');
                cctvBtn.classList.add('bg-blue-600');
                cctvBtn.firstElementChild.classList.add('translate-x-5');
            } else {
                cctvBtn.classList.remove('bg-blue-600');
                cctvBtn.classList.add('bg-gray-200');
                cctvBtn.firstElementChild.classList.remove('translate-x-5');
            }
        }

        function showDetail(item) {
            const container = document.getElementById('sidebar-content');

            // Comment logic
            let gradeComment = "";
            let gradeColor = "";
            if (item.grade === 'A') {
                gradeComment = "ì•ˆì‹¬í•˜ì„¸ìš”! ìœµì ë¹„ìœ¨ê³¼ ê¶Œë¦¬ ê´€ê³„ê°€ ê¹¨ë—í•œ ì¶”ì²œ ë§¤ë¬¼ì…ë‹ˆë‹¤.";
                gradeColor = "text-green-600 bg-green-50 border-green-200";
            } else if (item.grade === 'B') {
                gradeComment = "ì£¼ë³€ ì‹œì„¸ ëŒ€ë¹„ í•©ë¦¬ì ì…ë‹ˆë‹¤. ë“±ê¸°ë¶€ë“±ë³¸ì„ í•œë²ˆ ë” í™•ì¸í•˜ì„¸ìš”.";
                gradeColor = "text-yellow-600 bg-yellow-50 border-yellow-200";
            } else if (item.grade === 'C') {
                gradeComment = "âš ï¸ ê·¼ë¦°ìƒí™œì‹œì„¤ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ê±°ìš© ìš©ë„ ë³€ê²½ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
                gradeColor = "text-orange-600 bg-orange-50 border-orange-200";
            } else {
                gradeComment = "ğŸš¨ <strong>ìœ„ë°˜ê±´ì¶•ë¬¼</strong> ë¦¬ìŠ¤í¬ê°€ ë†’ìŠµë‹ˆë‹¤. ì „ì„¸ëŒ€ì¶œ ë¶ˆê°€ ê°€ëŠ¥ì„± ì²´í¬ í•„ìˆ˜.";
                gradeColor = "text-red-600 bg-red-50 border-red-200";
            }

            // ë„¤ì´ë²„ ë¶€ë™ì‚° ë™ì  ë§í¬ ìƒì„±
            const searchKeyword = "ê´€ì•…êµ¬ ì‹ ë¦¼ë™ " + item.name;
            const naverUrl = "https://m.land.naver.com/search/result/" + encodeURIComponent(searchKeyword);

            // ê²½ì‚¬ë„ ë±ƒì§€ ë¡œì§
            let slopeBadge = '';
            if (item.slope <= 3) slopeBadge = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">ğŸŸ¢ ì™„ì „ í‰ì§€</span>';
            else if (item.slope <= 8) slopeBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">ğŸŸ¡ ì™„ë§Œí•œ ì–¸ë•</span>';
            else if (item.slope <= 15) slopeBadge = '<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">ğŸŸ  ì˜¤ë¥´ë§‰ê¸¸</span>';
            else slopeBadge = '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">ğŸ”´ ê¸‰ê²½ì‚¬ ì£¼ì˜</span>';

            container.innerHTML = `
                <div class="animate-fade-in h-full flex flex-col">
                    <button onclick="restoreList()" class="mb-4 text-xs font-bold text-slate-500 hover:text-blue-600 flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                    
                    <div class="flex-1 overflow-y-auto pr-1">
                        <!-- Safety Analysis Report -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 mb-4">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center justify-between">
                                <span>ğŸ›¡ï¸ ì•ˆì‹¬ ë¶„ì„ ë¦¬í¬íŠ¸</span>
                                <span class="px-2 py-1 rounded text-xs border ${gradeColor}">Grade ${item.grade}</span>
                            </h3>
                            
                            <!-- Radar Chart -->
                            <div class="relative h-48 mb-4 flex justify-center">
                                <canvas id="safetyChart"></canvas>
                            </div>

                            <!-- SWOT Analysis Section -->
                            <div class="mb-2 pt-4 border-t border-slate-100">
                                <div class="flex items-end gap-2 mb-3">
                                    <h3 class="font-bold text-sm text-slate-800">ğŸ”® ë¯¸ë˜ ê°€ì¹˜ ë¶„ì„ (SWOT)</h3>
                                    <span class="text-[10px] text-slate-400 font-medium pb-0.5">"ì˜ì›í•œ ê±´ ì ˆëŒ€ ì—†ì–´!"</span>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-blue-50 p-2.5 rounded-lg border border-blue-100">
                                        <h4 class="text-[11px] font-bold text-blue-700 mb-1 flex items-center"><i class="fa-solid fa-thumbs-up mr-1.5"></i>S (ê°•ì )</h4>
                                        <ul class="text-[10px] text-slate-600 space-y-0.5 list-disc list-inside">
                                            ${item.swot ? item.swot.s.map(t => `<li class="truncate">${t}</li>`).join('') : '<li>ë¶„ì„ ì¤‘...</li>'}
                                        </ul>
                                    </div>
                                    <div class="bg-red-50 p-2.5 rounded-lg border border-red-100">
                                        <h4 class="text-[11px] font-bold text-red-700 mb-1 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-1.5"></i>W (ì•½ì )</h4>
                                        <ul class="text-[10px] text-slate-600 space-y-0.5 list-disc list-inside">
                                            ${item.swot ? item.swot.w.map(t => `<li class="truncate">${t}</li>`).join('') : '<li>ë¶„ì„ ì¤‘...</li>'}
                                        </ul>
                                    </div>
                                    <div class="bg-green-50 p-2.5 rounded-lg border border-green-100">
                                        <h4 class="text-[11px] font-bold text-green-700 mb-1 flex items-center"><i class="fa-solid fa-seedling mr-1.5"></i>O (ê¸°íšŒ)</h4>
                                        <ul class="text-[10px] text-slate-600 space-y-0.5 list-disc list-inside">
                                            ${item.swot ? item.swot.o.map(t => `<li class="truncate">${t}</li>`).join('') : '<li>ë¶„ì„ ì¤‘...</li>'}
                                        </ul>
                                    </div>
                                    <div class="bg-orange-50 p-2.5 rounded-lg border border-orange-100">
                                        <h4 class="text-[11px] font-bold text-orange-700 mb-1 flex items-center"><i class="fa-solid fa-skull-crossbones mr-1.5"></i>T (ìœ„í˜‘)</h4>
                                        <ul class="text-[10px] text-slate-600 space-y-0.5 list-disc list-inside">
                                            ${item.swot ? item.swot.t.map(t => `<li class="truncate">${t}</li>`).join('') : '<li>ë¶„ì„ ì¤‘...</li>'}
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Comment -->
                            <div class="p-3 rounded-xl border text-xs leading-relaxed ${gradeColor}">
                                ${gradeComment}
                            </div>
                        </div>

                        <!-- Basic Info -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden shrink-0">
                            <div class="h-32 bg-slate-100 flex items-center justify-center relative">
                                <i class="fa-solid fa-house text-4xl text-slate-300"></i>
                                <div class="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black/60 to-transparent">
                                    <span class="text-white font-bold text-xl">${formatPrice(item.price)}</span>
                                </div>
                            </div>
                            <div class="p-5">
                                <div class="flex gap-2 mb-3">
                                    <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">${TypeNames[item.type]}</span>
                                    <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">${item.size}í‰</span>
                                </div>
                                <h2 class="text-lg font-bold text-slate-900 mb-2">${item.name}</h2>
                                <p class="text-xs text-slate-500 mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-location-dot"></i> ì‹ ë¦¼ì—­ ì¸ê·¼ Â· ${item.floor}
                                </p>
                                <div class="flex items-center gap-2 mb-6">
                                    ${slopeBadge}
                                    <span class="text-xs text-gray-400">ê²½ì‚¬ë„ ${item.slope}Â°</span>
                                </div>
                                <a href="${naverUrl}" target="_blank" 
                                    class="flex items-center justify-center gap-2 w-full py-3 bg-[#03C75A] hover:bg-[#02b351] text-white font-bold rounded-xl shadow-md transition-colors text-sm">
                                    <span class="font-extrabold text-base">N</span> ë„¤ì´ë²„ ë¶€ë™ì‚° ì‹œì„¸ ë³´ê¸° â†—ï¸
                                </a>
                                
                                <div class="mt-4 pt-4 border-t border-slate-100">
                                    <h4 class="text-xs font-bold text-slate-500 mb-2">ğŸ—£ï¸ ì…ì£¼ë¯¼ ì° í›„ê¸°</h4>
                                    ${item.reviewCount > 0
                    ? `<div class="bg-purple-50 p-3 rounded-xl border border-purple-100">
                                             <div class="flex items-center gap-1 mb-1">
                                                 <span class="text-xs font-bold text-purple-700">â˜… ${item.rating}</span>
                                                 <span class="text-[10px] text-purple-400">(${item.reviewCount}ê°œ ë¦¬ë·°)</span>
                                             </div>
                                             <p class="text-xs text-slate-700 font-medium">"${item.pros}"</p>
                                           </div>`
                    : `<div class="text-center py-4 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                                             <span class="text-xs text-slate-400">ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
                                           </div>`
                }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (window.innerWidth < 768) toggleSidebar(true);

            // Render Chart
            renderChart(item.scores);
        }

        function showZoneDetail(props) {
            const container = document.getElementById('sidebar-content');

            let gradeColor = "";
            let gradeComment = "";
            if (props.grade === 'A') {
                gradeColor = "text-green-600 bg-green-50 border-green-200";
                gradeComment = "ì•ˆì „ ë“±ê¸‰ ìµœìš°ìˆ˜ ì§€ì—­ì…ë‹ˆë‹¤.";
            } else if (props.grade === 'B') {
                gradeColor = "text-yellow-600 bg-yellow-50 border-yellow-200";
                gradeComment = "ëŒ€ì²´ë¡œ ì–‘í˜¸í•˜ë‚˜ ì¼ë¶€ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
            } else if (props.grade === 'C') {
                gradeColor = "text-orange-600 bg-orange-50 border-orange-200";
                gradeComment = "ìƒí™œ ì¹˜ì•ˆ ë° ì£¼ê±° í™˜ê²½ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.";
            } else {
                gradeColor = "text-red-600 bg-red-50 border-red-200";
                gradeComment = "ì§‘ì¤‘ ê´€ë¦¬ ëŒ€ìƒ ì§€ì—­ì…ë‹ˆë‹¤.";
            }

            const stats = props.stats || { cctv: 0, infra: 0, viol_rate: 0 };

            container.innerHTML = `
                <div class="animate-fade-in h-full flex flex-col">
                    <button onclick="restoreList()" class="mb-4 text-xs font-bold text-slate-500 hover:text-blue-600 flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                    
                    <div class="flex-1 overflow-y-auto pr-1">
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 mb-4">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center justify-between">
                                <span>ğŸ›¡ï¸ ${props.adm_nm} ì•ˆì‹¬ ë¦¬í¬íŠ¸</span>
                                <span class="px-2 py-1 rounded text-xs border ${gradeColor}">Grade ${props.grade}</span>
                            </h3>
                            <div class="relative h-48 mb-4 flex justify-center">
                                <canvas id="safetyChart"></canvas>
                            </div>
                            <div class="p-3 rounded-xl border text-xs leading-relaxed ${gradeColor}">
                                ${gradeComment}
                            </div>
                        </div>

                         <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5">
                            <h4 class="font-bold text-slate-700 mb-3 text-sm">ğŸ“Š ì§€ì—­ í†µê³„</h4>
                            <div class="grid grid-cols-2 gap-3 text-center">
                                <div class="bg-slate-50 p-3 rounded-xl">
                                    <div class="text-xs text-slate-500 mb-1">CCTV</div>
                                    <div class="font-bold text-blue-600">${stats.cctv}ëŒ€</div>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-xl">
                                    <div class="text-xs text-slate-500 mb-1">í¸ì˜ì‹œì„¤</div>
                                    <div class="font-bold text-slate-700">${stats.infra}ê°œ</div>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-xl col-span-2">
                                    <div class="text-xs text-slate-500 mb-1">ìœ„ë°˜ê±´ì¶•ë¬¼ ë¹„ìœ¨</div>
                                    <div class="font-bold ${stats.viol_rate > 0.3 ? 'text-red-500' : 'text-green-600'}">${(stats.viol_rate * 100).toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (window.innerWidth < 768) toggleSidebar(true);

            renderChart(props.scores);
        }

        function showToast(message) {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.className = 'toast-msg';
            toast.innerText = message;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('toast-out');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }

        function restoreList() {
            renderInitialList();
            applyFilter();
        }

        function renderChart(scores) {
            const ctx = document.getElementById('safetyChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: [
                        `ì¹˜ì•ˆÂ·ì•ˆì „ ${scores.security_safety > 80 ? '(ğŸ‘ì•ˆì‹¬)' : ''}`,
                        `ë¬¼ê±´/ê±´ë¬¼ ${scores.property_building < 50 ? '(ğŸ‘ë…¸í›„)' : ''}`,
                        `ì£¼ê±° ì¾Œì ì„± ${scores.living_comfort > 80 ? '(ğŸ‘ìˆ²ì„¸ê¶Œ)' : ''}`,
                        `ìƒí™œ ì¸í”„ë¼ ${scores.living_infra > 80 ? '(ğŸ‘ìŠ¬ì„¸ê¶Œ)' : ''}`,
                        `êµí†µ ${scores.traffic > 80 ? '(ğŸ‘ì´ˆì—­ì„¸ê¶Œ)' : ''}`,
                        `í™˜ê²½ ${scores.environment < 40 ? '(ğŸ‘ì†ŒìŒ)' : ''}`
                    ],
                    datasets: [{
                        label: 'ì•ˆì‹¬ ì ìˆ˜',
                        data: [
                            scores.security_safety,
                            scores.property_building,
                            scores.living_comfort,
                            scores.living_infra,
                            scores.traffic,
                            scores.environment
                        ],
                        fill: true,
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                        borderColor: 'rgb(37, 99, 235)',
                        pointBackgroundColor: 'rgb(37, 99, 235)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(37, 99, 235)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            ticks: { display: false, stepSize: 20 },
                            pointLabels: {
                                font: { size: 10, family: 'Pretendard', weight: 'bold' },
                                color: '#475569'
                            }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function toggleSidebar(show) {
            const sb = document.getElementById('sidebar');
            if (window.innerWidth < 768) show ? sb.classList.remove('translate-y-full') : sb.classList.add('translate-y-full');
        }
    </script>
    <script>
        // [ê¸°ëŠ¥ ë³µêµ¬] ê²€ìƒ‰ ë° ê°œì¸í™” í™œì„±í™”
        // [ê¸°ëŠ¥ ë³µêµ¬] ê²€ìƒ‰ ë° ê°œì¸í™” í™œì„±í™”
        function applyPersonalization(data, typeId) {
            const toast = document.getElementById('persona-toast');
            const nameSpan = document.getElementById('persona-name');
            const typeNames = {
                '1': 'ì²­ì™€ëŒ€ ê²½í˜¸ì‹¤ì¥í˜•', '2': 'ìˆœê°„ì´ë™ ëŠ¥ë ¥ìí˜•', '3': 'í”„ë¡œ í¸ì˜ì  ëŸ¬ë²„í˜•', '4': 'ì‹¤ì†íŒŒ ê°“ìƒëŸ¬í˜•',
                '5': 'ëŒ€ì¹˜ë™ í•™ì›ê°€ ë“œë¦¬í”„íŠ¸í˜•', '6': 'ìˆ²ì„¸ê¶Œ ì€ë‘” ê³ ìˆ˜í˜•', '7': 'ë°°ë‹¬ì˜ë¯¼ì¡± VVIPí˜•', '8': 'ê°•ë‚¨í–‰ êµë‘ë³´ í—Œí„°í˜•',
                '9': 'í•œê°•ê³µì› ëŸ¬ë‹ í¬ë£¨í˜•', '10': 'í’€ì˜µì…˜ ë¯¸ë‹ˆë©€ë¦¬ìŠ¤íŠ¸í˜•', '11': 'ì£¼ì°¨ì¥ ë³´ì•ˆ ìš”ì›í˜•', '12': 'í”„ë¡œ ì§‘ì½•ëŸ¬í˜•',
                '13': 'ìš°ë¦¬ ë™ë„¤ ë³´ì•ˆê´€í˜•', '14': 'ê°€ì„±ë¹„ ì‹ ë„ì‹œ ì´ì£¼ë¯¼í˜•', '15': '1ì¸ ê°€êµ¬ ì„¸íƒ ìš”ì •í˜•', '16': 'ì»¤ë®¤ë‹ˆí‹° ì •ë³µìí˜•'
            };

            // Recommendation Data Definition
            const recommendationData = {
                '1': [ // ì¹˜ì•ˆ
                    { name: 'ì†¡íŒŒêµ¬ ì ì‹¤ë™', desc: 'ì¹˜ì•ˆ 1ë“±ê¸‰ Â· CCTV ë°€ì§‘ë„ ìµœìƒ', lat: 37.512, lng: 127.086 },
                    { name: 'ì„œì´ˆêµ¬ ë°˜í¬ë™', desc: 'ìœ í•´ì‹œì„¤ 0% Â· ì•ˆì‹¬ ì£¼ê±°ì§€ì—­', lat: 37.503, lng: 127.005 },
                    { name: 'ê°•ë‚¨êµ¬ ì¼ì›ë™', desc: 'ê²½ì°°ì„œ ì ‘ê·¼ì„± ìš°ìˆ˜ Â· ì¾Œì ', lat: 37.491, lng: 127.087 }
                ],
                '2': [ // êµí†µ
                    { name: 'ë§ˆí¬êµ¬ ì„œêµë™', desc: '2í˜¸ì„ /ê³µí•­ì² ë„ ë”ë¸” ì—­ì„¸ê¶Œ', lat: 37.553, lng: 126.922 },
                    { name: 'ê´€ì•…êµ¬ ì²­ë£¡ë™', desc: 'ê°•ë‚¨ ì ‘ê·¼ì„± íƒì›” Â· 2í˜¸ì„ ', lat: 37.479, lng: 126.953 },
                    { name: 'ë™ì‘êµ¬ ì‚¬ë‹¹ë™', desc: 'êµí†µì˜ ìš”ì§€ Â· 4í˜¸ì„ /2í˜¸ì„ ', lat: 37.483, lng: 126.981 }
                ],
                '3': [ // í¸ì˜
                    { name: 'ê°•ë‚¨êµ¬ ì—­ì‚¼1ë™', desc: 'ëª¨ë“  í¸ì˜ì‹œì„¤ ë„ë³´ 5ë¶„', lat: 37.500, lng: 127.036 },
                    { name: 'ê´‘ì§„êµ¬ í™”ì–‘ë™', desc: 'ë¨¹ìê³¨ëª©/ì‹œì¥ ì¸ì ‘ ê±´ëŒ€ì…êµ¬', lat: 37.541, lng: 127.070 },
                    { name: 'ê´€ì•…êµ¬ ì‹ ë¦¼ë™', desc: '1ì¸ ê°€êµ¬ ìµœì í™” ìƒê¶Œ', lat: 37.483, lng: 126.928 }
                ],
                '4': [ // ìì—° (ì‹¤ì†+í™˜ê²½)
                    { name: 'ê´‘ì§„êµ¬ ìì–‘ë™', desc: 'í•œê°•ê³µì› ë°”ë¡œ ì• ì¾Œì ì„±', lat: 37.531, lng: 127.074 },
                    { name: 'ë§ˆí¬êµ¬ ë§ì›ë™', desc: 'ë§ì›í•œê°•ê³µì› ì¸ì ‘', lat: 37.556, lng: 126.901 },
                    { name: 'ì„±ë™êµ¬ ì„±ìˆ˜ë™', desc: 'ì„œìš¸ìˆ²ì„¸ê¶Œì˜ ì—¬ìœ ', lat: 37.544, lng: 127.044 }
                ],
                '5': [ // ì§ì£¼ (êµìœ¡/í•™ì›ê°€ë¡œ ìš”ì²­ ë³€ê²½ë¨ -> ëŒ€ì¹˜ë™ í•™ì›ê°€í˜•ì´ 5ë²ˆ? 5ë²ˆì€ ì§ì£¼?)
                    // ì‚¬ìš©ì ìš”ì²­ 5ë²ˆ=ë´‰ì²œ/ìƒê³„(ì§ì£¼ê·¼ì ‘)ìœ¼ë¡œ ëª…ì‹œë¨
                    { name: 'ê´€ì•…êµ¬ ë´‰ì²œë™', desc: 'ê°•ë‚¨ ì¶œí‡´ê·¼ ìš©ì´í•œ ê°€ì„±ë¹„', lat: 37.482, lng: 126.952 },
                    { name: 'ë…¸ì›êµ¬ ìƒê³„ë™', desc: 'ë™ë¶ê¶Œ ì§ì£¼ê·¼ì ‘ ì¤‘ì‹¬', lat: 37.660, lng: 127.073 },
                    { name: 'ê°•ì„œêµ¬ í™”ê³¡ë™', desc: 'ì—¬ì˜ë„/ë§ˆê³¡ ì¶œí‡´ê·¼ ìµœì ', lat: 37.540, lng: 126.845 }
                ],
                '6': [ // êµìœ¡ (ìˆ²ì„¸ê¶Œìœ¼ë¡œ ëª…ì‹œë˜ì–´ ìˆìœ¼ë‚˜ ë°ì´í„°ëŠ” êµìœ¡?)
                    // ì‚¬ìš©ì ìš”ì²­ 6ë²ˆ=ëŒ€ì¹˜/ì¤‘ê³„(êµìœ¡)
                    { name: 'ê°•ë‚¨êµ¬ ëŒ€ì¹˜ë™', desc: 'ëŒ€í•œë¯¼êµ­ ì‚¬êµìœ¡ 1ë²ˆì§€', lat: 37.495, lng: 127.061 },
                    { name: 'ë…¸ì›êµ¬ ì¤‘ê³„ë™', desc: 'ê°•ë¶ì˜ ëŒ€ì¹˜ë™ ì€í–‰ì‚¬ê±°ë¦¬', lat: 37.649, lng: 127.076 },
                    { name: 'ì–‘ì²œêµ¬ ëª©ë™', desc: 'ì „í†µ ëª…ë¬¸ í•™êµ° ì§€ì—­', lat: 37.528, lng: 126.871 }
                ],
                // ê°€ìƒ ë°ì´í„° (7~16) - ì„ì˜ í• ë‹¹
                '7': [{ name: 'ê´€ì•…êµ¬ ì‹ ë¦¼ë™', desc: 'ë°°ë‹¬ ë§›ì§‘ ìµœë‹¤ ë°€ì§‘', lat: 37.483, lng: 126.928 }, { name: 'ê°•ë‚¨êµ¬ ë…¼í˜„ë™', desc: '24ì‹œê°„ ë°°ë‹¬ ê°€ëŠ¥ ì§€ì—­', lat: 37.511, lng: 127.028 }, { name: 'ì†¡íŒŒêµ¬ ë°©ì´ë™', desc: 'ë¨¹ìê³¨ëª© ì¸í”„ë¼', lat: 37.510, lng: 127.110 }],
                '8': [{ name: 'ì„œì´ˆêµ¬ ë°˜í¬ë™', desc: 'ê°•ë‚¨ ì ‘ê·¼ì„± ìµœìƒ', lat: 37.503, lng: 127.005 }, { name: 'ì„±ë™êµ¬ ì˜¥ìˆ˜ë™', desc: 'ê°•ë‚¨ ì§„ì… 5ë¶„', lat: 37.541, lng: 127.017 }, { name: 'ë™ì‘êµ¬ í‘ì„ë™', desc: '9í˜¸ì„ ë¼ì¸ í™©ê¸ˆ ì…ì§€', lat: 37.508, lng: 126.963 }],
                '9': [{ name: 'ì„œì´ˆêµ¬ ì ì›ë™', desc: 'ì ì›í•œê°•ê³µì› ëŸ¬ë‹ì½”ìŠ¤', lat: 37.519, lng: 127.012 }, { name: 'ì˜ë“±í¬êµ¬ ì—¬ì˜ë„ë™', desc: 'ì—¬ì˜ë„ ê³µì› ëŸ¬ë‹', lat: 37.521, lng: 126.924 }, { name: 'ë§ˆí¬êµ¬ ìƒìˆ˜ë™', desc: 'í•œê°•ë³€ ì¡°ê¹… ì½”ìŠ¤', lat: 37.547, lng: 126.922 }],
                '10': [{ name: 'ê´€ì•…êµ¬ ë´‰ì²œë™', desc: 'í’€ì˜µì…˜ ì›ë£¸ ë‹¤ìˆ˜', lat: 37.482, lng: 126.952 }, { name: 'ë™ì‘êµ¬ ë…¸ëŸ‰ì§„ë™', desc: 'ê°€ì„±ë¹„ í’€ì˜µì…˜', lat: 37.513, lng: 126.941 }, { name: 'êµ¬ë¡œêµ¬ êµ¬ë¡œë™', desc: 'ì˜¤í”¼ìŠ¤í…” ë°€ì§‘', lat: 37.494, lng: 126.886 }],
                '11': [{ name: 'ê°•ë™êµ¬ ì²œí˜¸ë™', desc: 'ì£¼ì°¨ ê³µê°„ í™•ë³´ ìš©ì´', lat: 37.543, lng: 127.125 }, { name: 'ì†¡íŒŒêµ¬ ê°€ë½ë™', desc: 'ì‹ ì¶• ë¹Œë¼ í•„ë¡œí‹° ì£¼ì°¨', lat: 37.496, lng: 127.123 }, { name: 'ì€í‰êµ¬ ì—°ì‹ ë‚´', desc: 'ë‹¨ë…ì£¼íƒ ì£¼ì°¨ì¥', lat: 37.618, lng: 126.920 }],
                '12': [{ name: 'ê²½ê¸°ë„ ê¹€í¬ì‹œ', desc: 'ë„“ì€ í‰ìˆ˜ ì¾Œì í•œ ì§‘', lat: 37.615, lng: 126.715 }, { name: 'ë‚¨ì–‘ì£¼ ë‹¤ì‚°', desc: 'ì¡°ìš©í•œ ì‹ ë„ì‹œ ë¼ì´í”„', lat: 37.625, lng: 127.160 }, { name: 'íŒŒì£¼ ìš´ì •', desc: 'ì¾Œì í•œ ëŒ€ë‹¨ì§€', lat: 37.716, lng: 126.747 }],
                '13': [{ name: 'ì„œëŒ€ë¬¸êµ¬ ì—°í¬ë™', desc: 'ì´ì›ƒ ê°„ ì†Œí†µ í™œë°œ', lat: 37.570, lng: 126.931 }, { name: 'ì¢…ë¡œêµ¬ ë¶€ì•”ë™', desc: 'ì „í†µì ì¸ ë§ˆì„ ê³µë™ì²´', lat: 37.592, lng: 126.965 }, { name: 'ì„±ë¶êµ¬ ì„±ë¶ë™', desc: 'ì•ˆì „í•˜ê³  ì¡°ìš©í•œ ë§ˆì„', lat: 37.596, lng: 126.992 }],
                '14': [{ name: 'í•˜ë‚¨ ë¯¸ì‚¬', desc: 'ì‹ ì¶• ì¸í”„ë¼ ê°€ì„±ë¹„', lat: 37.561, lng: 127.195 }, { name: 'ê³ ì–‘ ì‚¼ì†¡', desc: 'ìŠ¤íƒ€í•„ë“œì„¸ê¶Œ', lat: 37.647, lng: 126.897 }, { name: 'ì¸ì²œ ì†¡ë„', desc: 'êµ­ì œë„ì‹œ ì¸í”„ë¼', lat: 37.394, lng: 126.639 }],
                '15': [{ name: 'ê°•ë‚¨êµ¬ ë…¼í˜„ë™', desc: 'ì½”ì¸ì„¸íƒì†Œ ë‹¤ìˆ˜', lat: 37.511, lng: 127.028 }, { name: 'ë§ˆí¬êµ¬ ì—°ë‚¨ë™', desc: 'ì„¸íƒ í¸ì˜ì  ë§ìŒ', lat: 37.561, lng: 126.925 }, { name: 'ê´€ì•…êµ¬ ëŒ€í•™ë™', desc: '1ì¸ ê°€êµ¬ ì„œë¹„ìŠ¤ ìµœì ', lat: 37.469, lng: 126.937 }],
                '16': [{ name: 'ë§ˆí¬êµ¬ ë§ì›ë™', desc: 'ë§ì›ì‹œì¥ ì†Œëª¨ì„', lat: 37.556, lng: 126.901 }, { name: 'ìš©ì‚°êµ¬ í•´ë°©ì´Œ', desc: 'ë‹¤êµ­ì  ì»¤ë®¤ë‹ˆí‹°', lat: 37.544, lng: 126.987 }, { name: 'ì„±ë™êµ¬ ì„±ìˆ˜ë™', desc: 'í™í”Œë ˆì´ìŠ¤ í¬ë£¨', lat: 37.544, lng: 127.044 }]
            };

            const recList = recommendationData[typeId];

            if (toast && nameSpan && typeNames[typeId]) {
                nameSpan.innerText = typeNames[typeId];
                toast.classList.remove('hidden');
                toast.classList.add('animate-fade-in-up');

                // Recommendation UI Logic
                if (recList) {
                    const topRecBox = document.getElementById('top-recommendation');
                    const topTitle = document.getElementById('top-title');
                    const topList = document.getElementById('top-list');

                    if (topRecBox && topTitle && topList) {
                        topRecBox.classList.remove('hidden');
                        topTitle.innerText = typeNames[typeId];

                        const listHtml = recList.map((item, index) => `
                            <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-indigo-50 hover:border-indigo-300 cursor-pointer transition-colors shadow-sm" onclick="event.stopPropagation(); map.panTo(new kakao.maps.LatLng(${item.lat}, ${item.lng}));">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="bg-indigo-600 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">${index + 1}ìœ„</span>
                                        <span class="text-sm font-bold text-slate-800">${item.name}</span>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1 pl-1">${item.desc}</p>
                                </div>
                                <i class="fa-solid fa-chevron-right text-xs text-gray-300"></i>
                            </div>
                        `).join('');

                        topList.innerHTML = listHtml;

                        // Auto Pan to Top 1
                        if (recList.length > 0 && map) {
                            // Delay slightly to ensure map is ready
                            setTimeout(() => {
                                map.panTo(new kakao.maps.LatLng(recList[0].lat, recList[0].lng));
                            }, 300);
                        }
                    }
                }

                setTimeout(() => {
                    toast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => toast.classList.add('hidden'), 500);
                }, 4000);
            }
        }

        function activateSearch() {
            const searchInput = document.getElementById('keyword-input');
            const searchBtn = document.getElementById('search-btn');
            if (!searchInput || !searchBtn) return;

            const ps = new kakao.maps.services.Places();

            const runSearch = () => {
                const keyword = searchInput.value.trim();
                if (!keyword) { alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }

                ps.keywordSearch(keyword, (data, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        const bounds = new kakao.maps.LatLngBounds();
                        for (let i = 0; i < data.length; i++) {
                            bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
                        }
                        map.setBounds(bounds);
                    } else {
                        alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                });
            };

            searchBtn.onclick = runSearch;
            searchInput.onkeydown = (e) => { if (e.key === 'Enter') runSearch(); };
        }

        function toggleLegend() {
            const legend = document.getElementById('map-legend');
            // Simple toggle with animation class handling if needed, but 'hidden' is sufficient for now
            legend.classList.toggle('hidden');
        }

        window.addEventListener('load', () => {
            activateSearch();
            const params = new URLSearchParams(window.location.search);
            const currentType = params.get('type') || params.get('persona');
            if (currentType) {
                // ë°ì´í„° ë¡œë“œ ì‹œì  ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•œ ì§€ì—° ì‹¤í–‰
                setTimeout(() => applyPersonalization(null, currentType), 500);
            }
        });
    </script>
</body>

</html>